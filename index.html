<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>私人海域</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="温和安静 爱我所爱">
<meta property="og:type" content="website">
<meta property="og:title" content="私人海域">
<meta property="og:url" content="http://yluy.gitee.io/index.html">
<meta property="og:site_name" content="私人海域">
<meta property="og:description" content="温和安静 爱我所爱">
<meta property="og:locale">
<meta property="article:author" content="Sonata">
<meta property="article:tag" content="test">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="私人海域" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">私人海域</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yluy.gitee.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Hexo-无法加载图床图片" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/07/31/Hexo-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E5%9B%BE%E5%BA%8A%E5%9B%BE%E7%89%87/" class="article-date">
  <time datetime="2023-07-31T07:36:22.000Z" itemprop="datePublished">2023-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/07/31/Hexo-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E5%9B%BE%E5%BA%8A%E5%9B%BE%E7%89%87/">Hexo 无法加载图床图片</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前使用图床，markdown中直接引用图床的链接，这几天重新打开博客，发现所有的图片都失效了，变成404<br />
咔咔一顿搜，只有这个博主的方法是对的<br />
<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5b58ecce6443">https://www.jianshu.com/p/5b58ecce6443</a></p>
<p>因为我个人用的是butterfly主题，所以处理方式就是修改主题下的head.pug文件，添加下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">meta</span>(name=<span class="string">&quot;referrer&quot;</span> content=<span class="string">&quot;no-referrer&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>搞定！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2023/07/31/Hexo-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E5%9B%BE%E5%BA%8A%E5%9B%BE%E7%89%87/" data-id="clkqxrnog000s1fj4fmhng92p" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Javascript作用域与闭包" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/14/Javascript%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/" class="article-date">
  <time datetime="2022-03-14T04:01:38.000Z" itemprop="datePublished">2022-03-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>►<a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/14/Javascript%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/">Javascript作用域与闭包</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="作用域与闭包"><a class="markdownIt-Anchor" href="#作用域与闭包"></a> 作用域与闭包</h1>
<h2 id="概念"><a class="markdownIt-Anchor" href="#概念"></a> 概念</h2>
<p><strong>闭包是指有权访问另一个函数作用域中变量的函数</strong>。</p>
<p>创建闭包的最常见的方式就是在一个函数内创建另一个函数，创建的函数可以访问到当前函数的局部变量。</p>
<p>闭包有两个常用的用途：</p>
<ul>
<li>闭包的第一个用途是使我们在函数外部能够访问到函数内部的变量。通过使用闭包，可以通过在外部调用闭包函数，从而在外部访问到函数内部的变量，可以使用这种方法来创建私有变量。</li>
<li>闭包的另一个用途是使已经运行结束的函数上下文中的变量对象继续留在内存中，因为闭包函数保留了这个变量对象的引用，所以这个变量对象不会被回收。</li>
</ul>
<blockquote>
<p>闭包是一种保护私有变量的机制，在函数执行时形成私有的作用域，保护里面的私有变量不受外界干扰。直观的说就是形成一个不销毁的栈环境。</p>
</blockquote>
<h2 id="闭包作用域"><a class="markdownIt-Anchor" href="#闭包作用域"></a> 闭包作用域</h2>
<h3 id="函数作为返回值"><a class="markdownIt-Anchor" href="#函数作为返回值"></a> 函数作为返回值</h3>
<ul>
<li>fn函数内定义了一个局部变量，并返回一个匿名函数结果，该匿名函数保留了对该变量的引用。</li>
<li>在外层，我们使用f接收fn的返回值，得到的返回结果是一个函数，通过调用该函数，使得我们在fn函数的外部能够访问到函数内部的变量，同时调用之后该变量不会被回收。</li>
<li>注意，内部的函数绑定的是它附近的环境</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> cnt = <span class="number">1</span>;  <span class="comment">// 内部的函数绑定的是它附近的环境</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        cnt++;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(cnt)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">2</span>  <span class="comment">// 与此行无关</span></span><br><span class="line"><span class="keyword">var</span> f = <span class="title function_">fn</span>()  <span class="comment">// 以函数作为返回值 得到的是一个函数</span></span><br><span class="line"><span class="title function_">f</span>() <span class="comment">// 2</span></span><br><span class="line"><span class="title function_">f</span>() <span class="comment">// 3</span></span><br><span class="line"><span class="title function_">f</span>() <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>
<h3 id="函数作为参数"><a class="markdownIt-Anchor" href="#函数作为参数"></a> 函数作为参数</h3>
<p>注意，将fn传入test函数中，fn内引用的cnt是它那个环境下的变量cnt，值为2，所以最后输出结果为3</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> cnt = <span class="number">1</span>;</span><br><span class="line">    <span class="title function_">f</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cnt = <span class="number">2</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    cnt ++;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(cnt)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(fn)  <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h2 id="作用域"><a class="markdownIt-Anchor" href="#作用域"></a> 作用域</h2>
<h3 id="全局作用域和函数作用域"><a class="markdownIt-Anchor" href="#全局作用域和函数作用域"></a> 全局作用域和函数作用域</h3>
<p>（1）全局作用域</p>
<ul>
<li>最外层函数和最外层函数外面定义的变量拥有全局作用域</li>
<li>所有未定义直接赋值的变量自动声明为全局作用域</li>
<li>所有window对象的属性拥有全局作用域</li>
<li>全局作用域有很大的弊端，过多的全局作用域变量会污染全局命名空间，容易引起命名冲突。</li>
</ul>
<p>（2）函数作用域</p>
<ul>
<li>函数作用域声明在函数内部的变零，一般只有固定的代码片段可以访问到</li>
<li>作用域是分层的，内层作用域可以访问外层作用域，反之不行</li>
</ul>
<h3 id="块级作用域"><a class="markdownIt-Anchor" href="#块级作用域"></a> 块级作用域</h3>
<ul>
<li>使用ES6中新增的let和const指令可以声明块级作用域，块级作用域可以在函数中创建也可以在一个代码块中的创建（由<code>&#123; &#125;</code>包裹的代码片段）</li>
<li>let和const声明的变量不会有变量提升，也不可以重复声明</li>
<li>在循环中比较适合绑定块级作用域，这样就可以把声明的计数器变量限制在循环内部。</li>
</ul>
<h3 id="作用域链"><a class="markdownIt-Anchor" href="#作用域链"></a> <strong>作用域链</strong></h3>
<p>在当前作用域中查找所需变量，但是该作用域没有这个变量，那这个变量就是自由变量。如果在自己作用域找不到该变量就去父级作用域查找，依次向上级作用域查找，直到访问到window对象就被终止，这一层层的关系就是作用域链。</p>
<p>作用域链的作用是<strong>保证对执行环境有权访问的所有变量和函数的有序访问，通过作用域链，可以访问到外层环境的变量和函数。</strong></p>
<h2 id="this指向"><a class="markdownIt-Anchor" href="#this指向"></a> this指向</h2>
<p>this的指向是在使用时决定的，而不是定义时</p>
<table>
<thead>
<tr>
<th><strong>调用方式</strong></th>
<th><strong>this指向</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>普通函数调用</td>
<td>window全局</td>
</tr>
<tr>
<td>定时器函数</td>
<td>window全局</td>
</tr>
<tr>
<td>立即执行函数</td>
<td>window全局</td>
</tr>
<tr>
<td>构造函数调用</td>
<td>实例对象</td>
</tr>
<tr>
<td>对象方法调用</td>
<td>该方法所属对象</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name, age</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">age</span>  = age</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;构造函数里的this指向：&#x27;</span>, <span class="variable language_">this</span>)  <span class="comment">// p</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;对象方法里的this指向：&#x27;</span>, <span class="variable language_">this</span>)  <span class="comment">// p</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">asyncTest</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// setTimeout中的function实际上是在全局环境中执行的</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;定时器内普通函数的this指向：&#x27;</span>, <span class="variable language_">this</span>)  <span class="comment">// window</span></span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;定时器内箭头函数的this指向：&#x27;</span>, <span class="variable language_">this</span>) <span class="comment">// p</span></span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;yluy&#x27;</span>, <span class="number">12</span>)</span><br><span class="line">p.<span class="title function_">test</span>()</span><br><span class="line">p.<span class="title function_">asyncTest</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;普通函数内的this指向：&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fn</span>()  <span class="comment">// window</span></span><br></pre></td></tr></table></figure>
<h2 id="call-apply-bind-函数"><a class="markdownIt-Anchor" href="#call-apply-bind-函数"></a> call / apply / bind 函数</h2>
<h3 id="call函数"><a class="markdownIt-Anchor" href="#call函数"></a> call函数</h3>
<p><code>call[thisArg, args1, ..., args2]</code></p>
<ul>
<li>可以调用函数</li>
<li>可以改变函数内部的this指向</li>
<li>可以实现继承</li>
<li>传入的参数数量不固定，第一个参数是代表函数体内的this指向，从第二个参数开始往后是传入函数内的参数</li>
</ul>
<p><strong>手写call函数</strong></p>
<ul>
<li>处理传入的参数，第一个参数作为上下文对象（this），之后的参数传入需要调用的方法</li>
<li><strong>将函数作为上下文对象的一个属性</strong></li>
<li><strong>使用上下文对象来调用这个方法，并保存返回的结果</strong></li>
<li>删除刚才新增的属性</li>
<li>返回结果</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">myCall</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>)</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> t = args.<span class="title function_">shift</span>()</span><br><span class="line">    t.<span class="property">test</span> = self  <span class="comment">// 将函数作为上下文对象的一个属性</span></span><br><span class="line">    <span class="keyword">const</span> res = t.<span class="title function_">test</span>(...args) <span class="comment">// 传入参数</span></span><br><span class="line">    <span class="keyword">delete</span> t.<span class="property">test</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;此时的this的指向:&quot;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = test.<span class="title function_">myCall</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;yluy&#x27;</span>&#125;, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res:&#x27;</span>, res)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="apply函数"><a class="markdownIt-Anchor" href="#apply函数"></a> apply函数</h3>
<p><code>call[thisArg, [args1, ..., args2]]</code></p>
<p>apply 接受两个参数</p>
<ul>
<li>第一个参数指定了函数体内 this 对象的指向，</li>
<li>第二个参数为一个带下标的集合，这个集合可以为数组，也可以为类数组，apply 方法把这个集合中的元素作为参数传递给被调用的函数。</li>
</ul>
<p><strong>手写apply函数</strong></p>
<ul>
<li>处理传入的参数，第一个参数作为上下文对象（this），之后的参数传入需要调用的方法</li>
<li><strong>将函数作为上下文对象的一个属性</strong></li>
<li><strong>使用上下文对象来调用这个方法，并保存返回的结果</strong></li>
<li>删除刚才新增的属性</li>
<li>返回结果</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">myApply</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> t = <span class="variable language_">arguments</span>[<span class="number">0</span>]  <span class="comment">// 保存上下文对象</span></span><br><span class="line">    t.<span class="property">test</span> = self  <span class="comment">// 将函数作为上下文对象的一个属性</span></span><br><span class="line">    <span class="keyword">const</span> res = t.<span class="title function_">test</span>(...<span class="variable language_">arguments</span>[<span class="number">1</span>])  <span class="comment">// 使用上下文对象来调用该方法</span></span><br><span class="line">    <span class="keyword">delete</span> t.<span class="property">test</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;此时的this的指向:&quot;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = test.<span class="title function_">myApply</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;yluy&#x27;</span>&#125;, [<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res:&#x27;</span>, res)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="bind函数"><a class="markdownIt-Anchor" href="#bind函数"></a> bind函数</h3>
<ul>
<li>改变this指向</li>
<li>第一个参数是this的值，后面的参数是函数接收的参数的值</li>
<li>改变this前后，原返回值不变</li>
</ul>
<p><strong>手写bind函数</strong></p>
<p>对<code>var f2 = test.bind(&#123;name : 'yluy'&#125;, 12, 3, 4)</code>进行分析：</p>
<ul>
<li><code>test.bind()</code>中的bind在调用时，内部的this指针指向的是test函数</li>
<li>bind函数其实是Function原型对象的方法</li>
<li>注意，f2拿到的返回值是一个函数</li>
</ul>
<p><strong>详细步骤</strong></p>
<ul>
<li>获取当前函数的引用，获取其余传入参数值</li>
<li>创建一个函数返回</li>
<li>函数内部使用apply来绑定函数调用， 这个时候需要传入当前函数的this给apply调用，其余参数都传入指定的上下文对象</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;此时的this的指向:&quot;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// var f1 = test(1, 2, 3)</span></span><br><span class="line"><span class="comment">// var f2 = test.bind(&#123;name : &#x27;yluy&#x27;&#125;, 12, 3, 4)</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">mybind</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> self = <span class="variable language_">this</span>  <span class="comment">// this指向原函数 也就是test</span></span><br><span class="line">    <span class="keyword">const</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>)</span><br><span class="line">    <span class="keyword">const</span> thisValue = args.<span class="title function_">shift</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bind返回一个新的函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> self.<span class="title function_">apply</span>(thisValue, args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f3 = test.<span class="title function_">mybind</span>(&#123;name : <span class="string">&#x27;sonata&#x27;</span>&#125;, <span class="number">12</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">f3</span>())</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2022/03/14/Javascript%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/" data-id="clkqxrnoi00101fj42yxk6lxm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Javascript原型与原型链" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/14/Javascript%E5%8E%9F%E5%9E%8B%E4%B8%8E%E5%8E%9F%E5%9E%8B%E9%93%BE/" class="article-date">
  <time datetime="2022-03-14T03:59:39.000Z" itemprop="datePublished">2022-03-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>►<a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/14/Javascript%E5%8E%9F%E5%9E%8B%E4%B8%8E%E5%8E%9F%E5%9E%8B%E9%93%BE/">Javascript原型与原型链</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="原型与原型链"><a class="markdownIt-Anchor" href="#原型与原型链"></a> 原型与原型链</h1>
<h3 id="javascript语言的继承机制"><a class="markdownIt-Anchor" href="#javascript语言的继承机制"></a> Javascript语言的继承机制</h3>
<p>Javascript语言的继承机制全靠一种很奇特的&quot;原型链&quot;（prototype chain）模式来实现，以下是它的形成过程：</p>
<p>在一开始的时候，JS打算用构造函数生成实例对象，可是存在一个缺点，那就是无法共享属性和方法。</p>
<p>比如，在DOG对象的构造函数中，设置一个实例对象的共有属性species。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">DOG</span>(<span class="params">name</span>)&#123;</span><br><span class="line">　　　　<span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">　　　　<span class="variable language_">this</span>.<span class="property">species</span> = <span class="string">&#x27;犬科&#x27;</span>;</span><br><span class="line">　　&#125;</span><br></pre></td></tr></table></figure>
<p>然后，生成两个实例对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dogA = <span class="keyword">new</span> <span class="title function_">DOG</span>(<span class="string">&#x27;大毛&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> dogB = <span class="keyword">new</span> <span class="title function_">DOG</span>(<span class="string">&#x27;二毛&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>这两个对象的species属性是独立的，修改其中一个，不会影响到另一个。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dogA.<span class="property">species</span> = <span class="string">&#x27;猫科&#x27;</span>;</span><br><span class="line"><span class="title function_">alert</span>(dogB.<span class="property">species</span>); <span class="comment">// 显示&quot;犬科&quot;，不受dogA的影响</span></span><br></pre></td></tr></table></figure>
<p>每一个实例对象，都有自己的属性和方法的副本。这不仅无法做到数据共享，也是极大的资源浪费。</p>
<p>考虑到这一点，JS决定为构造函数设置一个prototype属性。</p>
<p>这个属性包含一个对象（以下简称&quot;prototype对象&quot;），<strong>所有实例对象需要共享的属性和方法，都放在这个对象里面；那些不需要共享的属性和方法，就放在构造函数里面</strong>。</p>
<p><strong>实例对象一旦创建，将自动引用prototype对象的属性和方法</strong>。也就是说，实例对象的属性和方法，分成两种，一种是本地的，另一种是引用的。</p>
<p>以DOG构造函数为例，现在用prototype属性进行改写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">DOG</span>(<span class="params">name</span>)&#123;</span><br><span class="line">　　　　<span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">DOG</span>.<span class="property"><span class="keyword">prototype</span></span> = &#123; species : <span class="string">&#x27;犬科&#x27;</span> &#125;; <span class="comment">// &#123;&#125; 扩起来了 是对象！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dogA = <span class="keyword">new</span> <span class="title function_">DOG</span>(<span class="string">&#x27;大毛&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> dogB = <span class="keyword">new</span> <span class="title function_">DOG</span>(<span class="string">&#x27;二毛&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">alert</span>(dogA.<span class="property">species</span>); <span class="comment">// 犬科</span></span><br><span class="line"><span class="title function_">alert</span>(dogB.<span class="property">species</span>); <span class="comment">// 犬科</span></span><br></pre></td></tr></table></figure>
<p>现在，species属性放在prototype对象里，是两个实例对象共享的。只要修改了prototype对象，就会同时影响到两个实例对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">DOG</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">species</span> = <span class="string">&#x27;猫科&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">alert</span>(dogA.<span class="property">species</span>); <span class="comment">// 猫科</span></span><br><span class="line"><span class="title function_">alert</span>(dogB.<span class="property">species</span>); <span class="comment">// 猫科</span></span><br></pre></td></tr></table></figure>
<p>由于所有的实例对象共享同一个prototype对象，那么从外界看起来，prototype对象就好像是实例对象的原型，而实例对象则好像&quot;继承&quot;了prototype对象一样。</p>
<p>这就是Javascript继承机制的设计思想。</p>
<h3 id="原型"><a class="markdownIt-Anchor" href="#原型"></a> 原型</h3>
<ul>
<li>每个函数都有prototype属性，指向其原型对象；原型对象也会有一个constructor指针指回它的构造函数。</li>
<li>好处是由此构造函数实例化出来的对象，可以共享prototype对象中所包含的属性和方法。</li>
</ul>
<p>每当代码读取某个对象的某个属性的时候，都会执行一次搜索。</p>
<p>首先从对象实例本身（显式原型）开始，如果在实例中找到了该属性，则返回该属性的值，如果没有找到，则顺着原型链指针向上，到原型对象中去找，如果如果找到就返回该属性值。</p>
<h3 id="原型链"><a class="markdownIt-Anchor" href="#原型链"></a> 原型链</h3>
<ul>
<li>每个对象都拥有一个原型对象，可以通过__proto__指针指向其原型对象，并从中继承方法和属性；</li>
<li>原型对象也能拥有原型。</li>
<li>因此，在读取某个属性或调用某个函数的时候，如果当前对象的显式原型里面没有这个属性或函数，那么指针就会顺着原型链指针，去原型对象中去找；如果它也没有，指针又继续顺着原型链指针，去该原型对象的原型对象上找。</li>
</ul>
<p>js里完全依靠&quot;原型链&quot;(prototype chain)模式来实现继承。</p>
<p>proto：事实上就是原型链指针</p>
<p>prototype：上面说到这个是指向原型对象的</p>
<p>constructor：<strong>每一个原型对象都包含一个指向构造函数的指针</strong>，就是constructor</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2022/03/14/Javascript%E5%8E%9F%E5%9E%8B%E4%B8%8E%E5%8E%9F%E5%9E%8B%E9%93%BE/" data-id="clkqxrnoj00141fj4354zfp9a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Javascript异步编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/14/Javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" class="article-date">
  <time datetime="2022-03-14T03:55:11.000Z" itemprop="datePublished">2022-03-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>►<a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/">JavaScript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/14/Javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">Javascript异步编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="异步编程"><a class="markdownIt-Anchor" href="#异步编程"></a> 异步编程</h1>
<h2 id="概念"><a class="markdownIt-Anchor" href="#概念"></a> 概念</h2>
<p>同步：一定要等任务执行完了，得到结果，才执行下一个任务。（类似于串行）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; B -&gt; <span class="variable constant_">AJAX</span> 请求 -&gt; C ---------------------------</span><br></pre></td></tr></table></figure>
<p>异步：不等任务执行完，直接执行下一个任务。（类似于并行）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; B -&gt; C ---------------------------------------</span><br><span class="line">       -&gt; <span class="variable constant_">AJAX</span> 请求 --------------------------------</span><br></pre></td></tr></table></figure>
<p>当各个任务相互独立的时候，可以使用异步的方式执行，可以加速运行效率</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;C&quot;</span>)</span><br><span class="line"><span class="comment">// 输出顺序是 ACB</span></span><br></pre></td></tr></table></figure>
<h2 id="回调函数"><a class="markdownIt-Anchor" href="#回调函数"></a> 回调函数</h2>
<p>回调函数可以告诉异步任务下一步做什么。</p>
<p>当A B两个函数存在运行顺序的时候，可以使用嵌套回调函数进行维护。比如我们希望先打印A，过了一秒钟之后再打印B</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">B</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">A</span>()</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">B</span>()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>但是当需要顺序运行的函数非常多时，也会导致嵌套过多，导致代码横向的增长，不利于代码理解与维护，这也是JS中常提到的“<strong>回调地狱</strong>”。</p>
<p>同时，嵌套函数存在耦合性，修改起来很麻烦</p>
<h2 id="promise"><a class="markdownIt-Anchor" href="#promise"></a> Promise</h2>
<p>构造Promise对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 下一步</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>resolve 和 reject 都是函数，调用 resolve 代表一切正常，调用reject 代表出现异常</p>
<h3 id="三种状态"><a class="markdownIt-Anchor" href="#三种状态"></a> ****三种状态</h3>
<ul>
<li>Pending 待定：最初始状态</li>
<li>fulfilled 解决：执行了resolve()函数后，状态变为fulfilled，并执行then里的方法</li>
<li>rejected 拒绝：执行了reject()函数后，状态变为rejected，并执行catch里的方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a)  <span class="comment">// pending</span></span><br><span class="line">        <span class="title function_">resolve</span>(<span class="number">111</span>)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;   <span class="comment">// fulfilled</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(b)  <span class="comment">// pending</span></span><br><span class="line">        <span class="title function_">reject</span>(<span class="number">111</span>)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;   <span class="comment">// rejected</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在相应的函数中执行完了之后，Promise的状态还会改变</p>
<p>**then(): **</p>
<ul>
<li>正常返回的时候，Promise的状态是fulfilled</li>
<li>报错的时候，Promise的状态是rejected</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(a)  <span class="comment">// pending</span></span><br><span class="line">        <span class="title function_">resolve</span>(<span class="number">111</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// return 1;  a的状态为 fulfilled</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;报错&quot;</span>)  <span class="comment">// a的状态为 rejected</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>catch():</strong></p>
<ul>
<li>正常返回的时候，Promise状态是fulfilled，可以继续往下执行then函数</li>
<li>报错的时候，Promise状态是rejected</li>
</ul>
<p>由于then块默认会向下顺序执行，return无法将其中断，只能通过throw来跳转至catch实现中断。</p>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<ul>
<li>Promise 对象是异步编程的一种解决方案，一个 Promise 实例有三种状态，分别是pending、resolved 和 rejected，分别代表了进行中、已成功和已失败。</li>
<li>实例的状态只能由 pending 转变 resolved 或者rejected 状态，并且状态一经改变，就凝固了，无法再被改变了。</li>
<li>状态的改变是通过 resolve() 和 reject() 函数来实现的，可以在异步操作结束后调用这两个函数改变 Promise 实例的状态</li>
<li>resolve()执行后，调用then方法；reject()调用catch方法</li>
</ul>
<h2 id="async-await-异步函数"><a class="markdownIt-Anchor" href="#async-await-异步函数"></a> async / await 异步函数</h2>
<h4 id="概念理解"><a class="markdownIt-Anchor" href="#概念理解"></a> 概念理解</h4>
<ul>
<li>执行异步函数async函数，返回的都是Promise对象</li>
<li>在异步函数中使用await指令，可以简化Promise、then这一系列过程，async 函数需要等待await后的函数执行完成并且有了返回结果（Promise对象）之后，才能继续执行下面的代码</li>
<li>在await 指令后必须跟一个 Promise</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f1</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2&quot;</span>)  <span class="comment">// 输出顺序为 2 1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>使用try…catch来捕获await抛出的异常</strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">f1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> a = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f1</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2&quot;</span>)  <span class="comment">// 输出 2 3</span></span><br></pre></td></tr></table></figure>
<h4 id="await阻塞示例"><a class="markdownIt-Anchor" href="#await阻塞示例"></a> await阻塞示例</h4>
<p>在下面的代码中，await等待了一个Promise对象的返回，并在等待的过程中阻塞了后面的代码。</p>
<p><code>console.log(&quot;start&quot;)、test1() 、console.log(&quot;end&quot;)</code>是视为同步代码进行的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">11</span>)  <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">const</span> a = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">22</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">33</span>)  <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>)  <span class="comment">// 1</span></span><br><span class="line"><span class="title function_">test1</span>() </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>)  <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<p>在没有 <code>await</code> 的情况下执行 async 函数，它会立即执行，返回一个 Promise 对象，并且，绝不会阻塞后面的语句。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test1</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">11</span>)</span><br><span class="line">        <span class="keyword">const</span> a = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="number">22</span>)</span><br><span class="line">        <span class="comment">// 删除了await，立即返回一个promise对象 下一行不会被阻塞</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">33</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="asyncawait对比promise的优势"><a class="markdownIt-Anchor" href="#asyncawait对比promise的优势"></a> async/await对比Promise的优势</h3>
<ul>
<li>代码读起来更加同步，Promise虽然摆脱了回调地狱，但是then的链式调⽤也会带来额外的阅读负担</li>
<li>Promise传递中间值⾮常麻烦，⽽async/await⼏乎是同步的写法，⾮常优雅</li>
<li>错误处理友好，async/await可以⽤成熟的try/catch，Promise的错误捕获⾮常冗余</li>
</ul>
<h2 id="应用举例"><a class="markdownIt-Anchor" href="#应用举例"></a> 应用举例</h2>
<p>假如函数B需要使用函数A返回的值来进行调用，但可能由于受到网速的影响使得B被调用时还没有拿到A的返回值，导致调用失败，这时候也需要异步处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">A</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res = <span class="title function_">A</span>()  <span class="comment">// 调用完A之后直接打印 出现了错误</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res)  <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>
<h2 id="event-loop"><a class="markdownIt-Anchor" href="#event-loop"></a> Event Loop</h2>
<p><strong>Event Loop是什么</strong></p>
<p>在程序中设置两个线程：一个负责程序本身的运行，称为&quot;主线程&quot;；另一个负责主线程与其他进程（主要是各种I/O操作）的通信，被称为&quot;Event Loop线程&quot;（可以译为&quot;消息线程&quot;）。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h099t11fx5j20dw0b8dgl.jpg" alt="" /></p>
<p><strong>Event Loop执行顺序</strong></p>
<ul>
<li>先顺序执行同步代码、宏任务</li>
<li>同步栈为空，查询是否有异步代码需要执行</li>
<li>循环访问callback队列，执行所有微任务</li>
<li>执行完，是否需要渲染页面</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2022/03/14/Javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" data-id="clkqxrnol001b1fj4697222z8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-决策树笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/17/%E5%86%B3%E7%AD%96%E6%A0%91%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2021-12-17T12:48:40.000Z" itemprop="datePublished">2021-12-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/17/%E5%86%B3%E7%AD%96%E6%A0%91%E7%AC%94%E8%AE%B0/">决策树笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="生成步骤"><a class="markdownIt-Anchor" href="#生成步骤"></a> 生成步骤</h2>
<ol>
<li>特征选择</li>
<li>决策树的生成</li>
<li>剪枝</li>
</ol>
<h2 id="特征选择"><a class="markdownIt-Anchor" href="#特征选择"></a> 特征选择</h2>
<p>某件事的不确定性越大，需要了解的信息就越多；在统计中，用熵度量随机变量的不确定性；</p>
<p><strong>熵越大，随机变量的不确定就越大</strong></p>
<h3 id="信息熵"><a class="markdownIt-Anchor" href="#信息熵"></a> <strong>信息熵</strong></h3>
<p>若一个随机变量Y的取值为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>Y</mi><mo>=</mo><mrow><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>c</mi><mn>2</mn></msub><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mrow><annotation encoding="application/x-tex">Y = {c_1, c_2...}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span></span></span>，概率分布为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>Y</mi><mo>=</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>p</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">P(Y = c_i) = p_i, i =1,2,..k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span></p>
<p>那么随机变量Y的熵定义为</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><msub><mi>p</mi><mi>i</mi></msub><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(Y) = -\sum_{i=1}^k p_ilog(p_i)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.1137820000000005em;vertical-align:-1.277669em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8361130000000003em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>举个例子：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>E</mi><mi>n</mi><mi>t</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>y</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mfrac><mn>1</mn><mn>6</mn></mfrac><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mfrac><mn>1</mn><mn>6</mn></mfrac><mo stretchy="false">)</mo><mo>−</mo><mfrac><mn>5</mn><mn>6</mn></mfrac><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mfrac><mn>5</mn><mn>6</mn></mfrac><mo>=</mo><mn>0.65</mn></mrow><annotation encoding="application/x-tex">Entropy(t) = -\frac{1}{6}log_2(\frac{1}{6})-\frac{5}{6}log_2\frac{5}{6} = 0.65
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span><span class="mord">5</span></span></span></span></span></p>
<h3 id="信息增益"><a class="markdownIt-Anchor" href="#信息增益"></a> 信息增益</h3>
<p>随机变量Y的熵H(Y)与Y的条件熵H(Y｜X)之差就是信息增益</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>Y</mi><mo separator="true">,</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><mo stretchy="false">(</mo><mi>Y</mi><mi mathvariant="normal">∣</mi><mi>X</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g(Y, X) = H(Y) - H(Y|X)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span></span></p>
<p><strong>信息增益依赖于特征，不同特征往往具有不同的信息增益。信息增益大的特征具有更强的分类能力。</strong></p>
<h3 id="信息增益比"><a class="markdownIt-Anchor" href="#信息增益比"></a> 信息增益比</h3>
<p>使用信息增益的缺点是，倾向于选择类别取之较多的特征</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mo stretchy="false">(</mo><mi>Y</mi><mo separator="true">,</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>Y</mi><mo separator="true">,</mo><mi>X</mi><mo stretchy="false">)</mo></mrow><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">Ratio(Y, X) = \frac{g(Y, X)}{H(X)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h3 id="基尼系数"><a class="markdownIt-Anchor" href="#基尼系数"></a> 基尼系数</h3>
<p>用于度量数据集的不纯度，指数越小，表明样本只属于同类的概率越高，即样本的纯度越高。</p>
<p>如下公式，Pk表示D中属于第k类的样本子集的概率，k为类别，N为类别的总数。</p>
<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gicssxx6poj30r803a74k.jpg" style="height:50px" />
$$
p_k = \frac{|C_k|}{|D|}
$$
<h2 id="决策树生成"><a class="markdownIt-Anchor" href="#决策树生成"></a> 决策树生成</h2>
<p>决策树的生成方法有三种：ID3、C4.5，CART树</p>
<h3 id="id3算法"><a class="markdownIt-Anchor" href="#id3算法"></a> ID3算法</h3>
<h4 id="缺点"><a class="markdownIt-Anchor" href="#缺点"></a> 缺点</h4>
<ol>
<li>不能处理连续值</li>
<li>容易过拟合</li>
<li>偏向于优先选取取值种类较多的特征</li>
</ol>
<h4 id="分裂停止条件"><a class="markdownIt-Anchor" href="#分裂停止条件"></a> 分裂停止条件</h4>
<p>停止条件有以下三种：</p>
<ul>
<li>当前集合的样本都属于同一类时，节点分裂停止</li>
<li>特征维度已经全部用完</li>
<li>每个特征的提纯效果都不太好，小于阈值</li>
</ul>
<h3 id="c45"><a class="markdownIt-Anchor" href="#c45"></a> C4.5</h3>
<h4 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h4>
<ol>
<li>将连续值离散化后，找出类别标签有变化的地方，取其中的值作为二分类划分的阈值，小于为一类，大于为一类</li>
<li>过拟合问题时因为决策树的生成过程中分支太细导致的，引入<strong>正则化系数</strong>控制节点的个数</li>
<li>用信息增益比来替代信息增益</li>
</ol>
<h4 id="缺点-2"><a class="markdownIt-Anchor" href="#缺点-2"></a> 缺点</h4>
<ol>
<li>和ID3一样，每个特征仅使用一次，使得特征信息的利用率较低</li>
<li>简单的离散化，使得信息丢失（类别的划分太随意</li>
</ol>
<h3 id="cart树"><a class="markdownIt-Anchor" href="#cart树"></a> CART树</h3>
<h4 id="特点"><a class="markdownIt-Anchor" href="#特点"></a> 特点</h4>
<ol>
<li>可以处理分类和回归的问题：分类的时候用基尼系数衡量，回归可以使用均方误差。回归时，叶子结点的值用所有子集的均值表示。</li>
<li>二叉树对每个特征或特征的取值进行划分。分类时切分子集，计算基尼指数或平方误差。回归时选择相邻两个值的中值作为划分点。</li>
</ol>
<h4 id="分类树和回归树的区别"><a class="markdownIt-Anchor" href="#分类树和回归树的区别"></a> 分类树和回归树的区别</h4>
<ul>
<li>
<p><strong>特征选择的标准不同</strong></p>
<ul>
<li>
<p>分类：某个特征的某个划分点的基尼指数</p>
</li>
<li>
<p>回归：选择某个特征的某个取值进行划分，使得均方误差和最小（小中小）</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><munder><mo>∑</mo><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>∈</mo><msub><mi>D</mi><mn>1</mn></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mi>c</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><munder><mo>∑</mo><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>∈</mo><msub><mi>D</mi><mn>2</mn></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><msub><mi>c</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sum_{x_i\in D_1}(y_i - c_1)^2 + \sum_{x_i\in D_2}(y_i - c_2)^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4444410000000003em;vertical-align:-1.394436em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.855664em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.394436em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.4444410000000003em;vertical-align:-1.394436em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.855664em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31731428571428577em;"><span style="top:-2.357em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.394436em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
</li>
</ul>
</li>
<li>
<p><strong>输出结果处理方式不同</strong></p>
<ul>
<li>分类：选择样本类别占多数者对应的类别标签作为该叶子结点的类别标签</li>
<li>回归：选择子集中所有样本的均值或者中位数作为输出值</li>
</ul>
</li>
</ul>
<h2 id="剪枝"><a class="markdownIt-Anchor" href="#剪枝"></a> 剪枝</h2>
<p>后剪枝比较常用，就是先构造好一棵树，比较剪掉某个子树与不剪时的损失函数；</p>
<p>选择结构损失，将叶子结点的个数作为损失函数的正则项考虑进去。</p>
<p>比如对于一颗以<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>T</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">T_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为根结点的子树，其结构损失为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>α</mi><mo separator="true">,</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>L</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mi mathvariant="normal">∣</mi><msub><mi>T</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">L(\alpha,T_i) = L(T_i) + \alpha|T_i|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span></span></span></p>
<p>如果把它作为单结点，将树枝全部减去，则有</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>α</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mi>L</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mo>∗</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">L(\alpha,i) = L(i) + \alpha * 1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>当两式相等时，把树枝全部减去的结点更少，效果更优，有：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>α</mi><mo>=</mo><mfrac><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>−</mo><mi>L</mi><mo stretchy="false">(</mo><msub><mi>T</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">∣</mi><msub><mi>T</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha = \frac{L(i) - L(T_i)}{|T_i| - 1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h4 id="剪枝步骤"><a class="markdownIt-Anchor" href="#剪枝步骤"></a> 剪枝步骤</h4>
<p>集合M存储的是自下而上的剪枝阈值</p>
<p>第三步从M中选择了最大的ak，自上而下进行判断，只要有比ak更小的a则剪枝，这说明不需要这么多结点即可达到与Tk（大）一样的效果，存入最优子树集合。</p>
<p>最后从最优子树集合中选出最优子树。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gxh43ehhqlj316y0pajw4.jpg" alt="" /></p>
<h2 id="代码实践"><a class="markdownIt-Anchor" href="#代码实践"></a> 代码实践</h2>
<h3 id="id3的构造过程"><a class="markdownIt-Anchor" href="#id3的构造过程"></a> ID3的构造过程</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author  : sonata</span></span><br><span class="line"><span class="string">@time    : 17/12/2021 17:11</span></span><br><span class="line"><span class="string">@File    : DecisionTree.py</span></span><br><span class="line"><span class="string">@Software: PyCharm</span></span><br><span class="line"><span class="string">@Role    : </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dataset</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot; 定义数据集 &quot;&quot;&quot;</span></span><br><span class="line">    dataset = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;N&#x27;</span>],</span><br><span class="line">               [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;N&#x27;</span>],</span><br><span class="line">               [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;Y&#x27;</span>],</span><br><span class="line">               [<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&#x27;Y&#x27;</span>],</span><br><span class="line">               [<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&#x27;Y&#x27;</span>],</span><br><span class="line">               [<span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;N&#x27;</span>],</span><br><span class="line">               [<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;Y&#x27;</span>]]</span><br><span class="line">    labels = [<span class="string">&#x27;outlook&#x27;</span>, <span class="string">&#x27;temperature&#x27;</span>, <span class="string">&#x27;humidity&#x27;</span>, <span class="string">&#x27;windy&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> dataset, labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_shannon_ent</span>(<span class="params">dataset</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算熵&quot;&quot;&quot;</span></span><br><span class="line">    num_entries = <span class="built_in">len</span>(dataset)</span><br><span class="line">    label_counts = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dataset:</span><br><span class="line">        current_label = i[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> current_label <span class="keyword">not</span> <span class="keyword">in</span> label_counts.keys():</span><br><span class="line">            label_counts[current_label] = <span class="number">0</span></span><br><span class="line">        label_counts[current_label] += <span class="number">1</span>  <span class="comment"># 每一类各多少个， &#123;&#x27;Y&#x27;: 4, &#x27;N&#x27;: 3&#125;</span></span><br><span class="line">    shannon_ent = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> label_counts:</span><br><span class="line">        prob = <span class="built_in">float</span>(label_counts[key]) / num_entries</span><br><span class="line">        shannon_ent -= prob * log(prob, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> shannon_ent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_dataset</span>(<span class="params">dataset, axis, value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;把选做特征的列除去&quot;&quot;&quot;</span></span><br><span class="line">    ret_dataset = []</span><br><span class="line">    <span class="keyword">for</span> example <span class="keyword">in</span> dataset:</span><br><span class="line">        <span class="keyword">if</span> example[axis] == value:</span><br><span class="line">            reduce_example = example[:axis]</span><br><span class="line">            reduce_example.extend(example[axis+<span class="number">1</span>:])</span><br><span class="line">            ret_dataset.append(reduce_example)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret_dataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose_best_feature</span>(<span class="params">dataset</span>):</span><br><span class="line">    num_feature = <span class="built_in">len</span>(dataset[<span class="number">0</span>]) - <span class="number">1</span></span><br><span class="line">    base_entropy = calculate_shannon_ent(dataset)</span><br><span class="line">    best_info_gain_ration = <span class="number">0.0</span></span><br><span class="line">    best_feature = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_feature):</span><br><span class="line">        feature_list = [example[i] <span class="keyword">for</span> example <span class="keyword">in</span> dataset]</span><br><span class="line">        unique_val = <span class="built_in">set</span>(feature_list)</span><br><span class="line">        new_entropy = <span class="number">0.0</span></span><br><span class="line">        split_info = <span class="number">0.0</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> unique_val:</span><br><span class="line">            sub_dataset = split_dataset(dataset, i, value)</span><br><span class="line">            prob = <span class="built_in">len</span>(sub_dataset) / <span class="built_in">float</span>(<span class="built_in">len</span>(dataset))</span><br><span class="line">            new_entropy += prob * calculate_shannon_ent(sub_dataset)</span><br><span class="line">            split_info += -prob * log(prob, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        info_gain = base_entropy - new_entropy  <span class="comment"># 以该特征作为分类的信息增益</span></span><br><span class="line">        <span class="keyword">if</span> split_info == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        info_gain_ratio = info_gain / base_entropy  <span class="comment"># 以该特征作为分类的信息增益比</span></span><br><span class="line">        <span class="keyword">if</span> info_gain_ratio &gt; best_info_gain_ration:</span><br><span class="line">            best_info_gain_ration = info_gain_ratio</span><br><span class="line">            best_feature = i</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> best_feature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">majority_cnt</span>(<span class="params">class_list</span>):</span><br><span class="line">    class_count = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> vote <span class="keyword">in</span> class_list:</span><br><span class="line">        <span class="keyword">if</span> vote <span class="keyword">not</span> <span class="keyword">in</span> class_count.keys():</span><br><span class="line">            class_count[vote] = <span class="number">0</span></span><br><span class="line">        class_count[vote] += <span class="number">1</span></span><br><span class="line">    sorted_class_count = <span class="built_in">sorted</span>(class_count.items(), key=<span class="keyword">lambda</span> kv: (kv[<span class="number">1</span>], kv[<span class="number">0</span>]), reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sorted_class_count[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_tree</span>(<span class="params">dataset, labels</span>):</span><br><span class="line">    class_list = [example[-<span class="number">1</span>] <span class="keyword">for</span> example <span class="keyword">in</span> dataset]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># class_list中所有元素都相等时，类别完全相同，停止划分</span></span><br><span class="line">    <span class="keyword">if</span> class_list.count(class_list[<span class="number">0</span>]) == <span class="built_in">len</span>(class_list):</span><br><span class="line">        <span class="keyword">return</span> class_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 只有一个类别的时候 直接统计最大样本的类别数</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(dataset[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> majority_cnt(class_list)</span><br><span class="line"></span><br><span class="line">    best_feat = choose_best_feature(dataset)</span><br><span class="line">    best_feat_label = labels[best_feat]</span><br><span class="line"></span><br><span class="line">    myTree = &#123;best_feat_label: &#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">del</span>(labels[best_feat])</span><br><span class="line"></span><br><span class="line">    feat_value = [example[best_feat] <span class="keyword">for</span> example <span class="keyword">in</span> dataset]</span><br><span class="line">    unique_value = <span class="built_in">set</span>(feat_value)</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> unique_value:</span><br><span class="line">        sub_label = labels[:]</span><br><span class="line">        myTree[best_feat_label][value] = create_tree(split_dataset(dataset, best_feat, value), sub_label)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> myTree</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dataset, labels = create_dataset()</span><br><span class="line">label_tmp = labels[:]</span><br><span class="line">decision_tree = create_tree(dataset, label_tmp)</span><br><span class="line"><span class="built_in">print</span>(decision_tree)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;outlook&#x27;</span>: &#123;<span class="number">0</span>: <span class="string">&#x27;N&#x27;</span>, <span class="number">1</span>: <span class="string">&#x27;Y&#x27;</span>, <span class="number">2</span>: &#123;<span class="string">&#x27;windy&#x27;</span>: &#123;<span class="number">0</span>: <span class="string">&#x27;Y&#x27;</span>, <span class="number">1</span>: <span class="string">&#x27;N&#x27;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>~~<br />
下次有机会再补上其他的吧</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/12/17/%E5%86%B3%E7%AD%96%E6%A0%91%E7%AC%94%E8%AE%B0/" data-id="clkqxrnq3006u1fj4d1i9azxj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-模型评估指标解读" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/02/%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time datetime="2021-12-02T03:02:15.000Z" itemprop="datePublished">2021-12-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/02/%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87%E8%A7%A3%E8%AF%BB/">模型评估指标解读</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="分类指标"><a class="markdownIt-Anchor" href="#分类指标"></a> 分类指标</h2>
<p>以下指标用于二分类问题，如果是多分类的问题，也可以使用1:M的方法转变成二分类进行计算。</p>
<h3 id="混淆矩阵-confusion-matrix"><a class="markdownIt-Anchor" href="#混淆矩阵-confusion-matrix"></a> 混淆矩阵 Confusion Matrix</h3>
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gwyjq0tj34j30xi0dsmy5.jpg" height="200px" />
<h3 id="准确率-accuracy"><a class="markdownIt-Anchor" href="#准确率-accuracy"></a> 准确率 - accuracy</h3>
<p>全局预测正确的样本数占所有样本数的比例，计算公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mi>c</mi><mi>c</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow><mrow><mi>A</mi><mi>L</mi><mi>L</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Acc = \frac{TP + TN}{ALL}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault">L</span><span class="mord mathdefault">L</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>缺点：在binary classification且正反例不平衡的情况下，计算准确率没有意义。</p>
<p>假设在测试集里，有100个sample，99个反例，只有1个正例。如果模型对任意一个sample都预测为反例，Acc是 正确的个数／总个数 = 99/100 = 99%，但显然这样的预测是不合理的。</p>
<h3 id="查准率-precision"><a class="markdownIt-Anchor" href="#查准率-precision"></a> 查准率 Precision</h3>
<p>所有预测为正样本的集合中预测正确的比例：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>P</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Precision = \frac{TP}{TP + FP}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h3 id="查全率-recall"><a class="markdownIt-Anchor" href="#查全率-recall"></a> 查全率 Recall</h3>
<p>所有正样本中预测正确的比例，即正样本的准确率。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>R</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Recall = \frac{TP}{TP + FN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>如果你的模型很贪婪，想要覆盖更多的sample，那么它就更有可能犯错。在这种情况下，你会有很高的recall，但是较低的precision。</p>
<p>如果你的模型很保守，只对它很sure的sample作出预测，那么你的precision会很高，但是recall会相对低。</p>
<h3 id="f1值"><a class="markdownIt-Anchor" href="#f1值"></a> F1值</h3>
<p>综合精确率和召回率指标，相当于调和均值。计算公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi><mn>1</mn><mo>=</mo><mfrac><mrow><mn>2</mn><mo>∗</mo><mi>P</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>∗</mo><mi>R</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi></mrow><mrow><mi>P</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>+</mo><mi>R</mi><mi>e</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>l</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">F1 = \frac{2 * Precision * Recall }{Precision + Recall}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.14077em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">i</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>缺点：如果两个模型，一个precision特别高，recall特别低，另一个recall特别高，precision特别低的时候，f1-score可能是差不多的，因此也不能基于此来作出选择。</p>
<p>当类别不平衡时，可以使用PR曲线和ROC曲线进行模型评估。</p>
<h3 id="roc曲线"><a class="markdownIt-Anchor" href="#roc曲线"></a> ROC曲线</h3>
<p>以TPR(True Positive Rate，真正率，等于召回率)为纵轴：所有正例中被预测为正例的概率。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>T</mi><mi>P</mi><mi>R</mi><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mi>P</mi></mfrac><mo>=</mo><mfrac><mrow><mi>T</mi><mi>P</mi></mrow><mrow><mi>T</mi><mi>P</mi><mo>+</mo><mi>F</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">TPR = \frac{TP}{P} = \frac{TP}{TP + FN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>FPR(False Positive Rate，假正率，不是真正的正)为横轴：所有负例中被预测为正例的概率。</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi><mi>P</mi><mi>R</mi><mo>=</mo><mfrac><mrow><mi>F</mi><mi>P</mi></mrow><mi>N</mi></mfrac><mo>=</mo><mfrac><mrow><mi>F</mi><mi>P</mi></mrow><mrow><mi>F</mi><mi>P</mi><mo>+</mo><mi>T</mi><mi>N</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">FPR = \frac{FP}{N} =\frac{FP}{FP + TN}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>当一个样本被分类器判为正例，若其本身是正例，则TPR增加；</p>
<p>若其本身是负例，则FPR增加，因此ROC曲线可以看作是随着阈值的不断移动，所有样本中正例与负例之间的“对抗”。</p>
<p>曲线越靠近左上角，意味着越多的正例优先于负例，模型的整体表现也就越好。</p>
<h4 id="作图"><a class="markdownIt-Anchor" href="#作图"></a> 作图</h4>
<p>在不同的分类阈值 (threshold) 设定下分别以TPR和FPR为纵、横轴作图。</p>
<ol>
<li>假设有P个正例，N个反例。</li>
<li>分类器对所有样本的正负例进行预测，将得到一个probability score，<strong>对所有样本按预测概率排序</strong>。</li>
<li>设定一个threshold，大于该值为正例，小于为负例。</li>
<li>将分类阈值设为最大，即把所有样本均预测为反例，对应图上的点为 (0,0)。</li>
<li>将分类阈值依次设为每个样本的预测概率，即依次将每个样本划分为正例，可以画出坐标轴中新的点</li>
<li>所有样本点的TPR和FPR值，用线段相连，如下图黄线所示。</li>
</ol>
<img src="https://pic3.zhimg.com/80/v2-70f8ba09d21ca845a1ec0c107e41212e_1440w.jpg?source=1940ef5c" height="400px" />
<ul>
<li>
<p>AUC = 1，是完美分类器，采用这个预测模型时，存在至少一个阈值能得出完美预测。绝大多数预测的场合，不存在完美分类器。</p>
</li>
<li>
<p>0.5 &lt; AUC &lt; 1，优于随机猜测。这个分类器（模型）妥善设定阈值（比如0.5）的话，能有预测价值。</p>
</li>
<li>
<p>AUC = 0.5，跟随机猜测一样（例如：抛硬币猜正反面），模型没有预测价值。</p>
</li>
<li>
<p>AUC &lt; 0.5，比随机猜测还差；但只要总是反预测而行，就优于随机猜测。</p>
</li>
</ul>
<h4 id="auc-area-under-the-curve"><a class="markdownIt-Anchor" href="#auc-area-under-the-curve"></a> AUC (Area Under the Curve)</h4>
<p>AUC需要计算折线下方的面积。</p>
<p>从所有正例中随机选取一个样本A，再从所有负例中随机选取一个样本B，分类器将A判为正例的概率比将B判为正例的概率大的可能性。</p>
<p>可以看到位于蓝色虚线上方的点(如图中的A点)被认为好于随机猜测。</p>
<p>在这样的点上TPR总大于FPR，意为正例被判为正例的概率大于负例被判为正例的概率。</p>
<img src="https://pic3.zhimg.com/80/v2-2dc9d2148aefd4bf6ff879b3b85837e6_1440w.jpg" alt="img" height="300px" />
<h4 id="优势"><a class="markdownIt-Anchor" href="#优势"></a> 优势</h4>
<ol>
<li>
<p>注意TPR用到的TP和FN同属P列，FPR用到的FP和TN同属N列，所以即使P或N的整体数量发生了改变，也不会影响到另一列。也就是说，<strong>即使正负例变得不平衡，ROC曲线也不会产生大的变化</strong>，而像Precision使用的TP和FP就分属两列，则易受类别分布改变的影响。</p>
</li>
<li>
<p>在类别不平衡的背景下，<strong>负例的数目众多致使FPR的增长不明显，导致ROC曲线呈现一个过分乐观的效果估计</strong>。当负例N的数量远超正例P时，FP的大幅增长只能换来FPR的微小改变。结果是虽然大量负例被错判成正例，在ROC曲线上却无法直观地看出来。</p>
<p>举个例子，假设一个数据集有正例20，负例10000，开始时有20个负例被错判，FPR=0.002 ，接着又有20个负例错判， FPR=0.004 ，在ROC曲线上这个变化是很细微的。而与此同时Precision则从原来的0.5下降到了0.33，在PR曲线上将会是一个大幅下降。</p>
</li>
</ol>
<h3 id="pr曲线"><a class="markdownIt-Anchor" href="#pr曲线"></a> PR曲线</h3>
<p>以查全率为横轴，查准率为纵轴，所以称为P(Precision 纵)R(Recall 横)曲线。</p>
<img src="https://pic1.zhimg.com/80/v2-6f09575f1a32692274177e7d2da55066_1440w.jpg?source=1940ef5c" height="250px" />
<p>曲线下的面积(AUC)越大，或者说曲线更接近右上角（precision=1， recall=1），那么模型就越理想，越好。</p>
<p><strong>类别不平衡问题中，PR曲线则因为Precision的存在会不断显现FP的影响。</strong></p>
<h3 id="适用场景"><a class="markdownIt-Anchor" href="#适用场景"></a> 适用场景</h3>
<p>地震的时候，模型应该将每一次地震都预测到，查全率需要尽可能高，做出错误预测也没有关系。</p>
<p>人脸识别的时候，模型应该尽可能提高查准率，不然就会导致把陌生人放进去。</p>
<p><strong>ROC与PR的选择</strong></p>
<ol>
<li>如果想要评估在<strong>相同</strong>的类别分布下正例的预测情况，则宜选PR曲线。</li>
<li>类别不平衡问题中，ROC曲线通常会给出一个乐观的效果估计，所以大部分时候还是PR曲线更好。</li>
<li>ROC曲线由于兼顾正例与负例，所以适用于评估分类器的整体性能，相比而言PR曲线完全聚焦于正例。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/12/02/%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87%E8%A7%A3%E8%AF%BB/" data-id="clkqxrnqn009u1fj41czj6vbo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-BatchNormalization原理与python实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/01/BatchNormalization%E5%8E%9F%E7%90%86%E4%B8%8Epython%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2021-12-01T10:58:08.000Z" itemprop="datePublished">2021-12-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/12/01/BatchNormalization%E5%8E%9F%E7%90%86%E4%B8%8Epython%E5%AE%9E%E7%8E%B0/">BatchNormalization原理与python实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h3>
<h4 id="炼丹困扰"><a class="markdownIt-Anchor" href="#炼丹困扰"></a> 炼丹困扰</h4>
<p>在深度学习中，由于问题的复杂性，我们往往会使用较深层数的网络进行训练，需要去尝试不同的学习率、初始化参数方法（例如Xavier初始化）等方式来帮助我们的模型加速收敛。</p>
<p>深度神经网络之所以如此难训练，其中一个重要原因就是网络中层与层之间存在<strong>高度的关联性与耦合性</strong>。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwy7jjormcj31400oudkb.jpg" alt="" /></p>
<p>网络中层与层之间的关联性会导致如下的状况：随着训练的进行，网络中的参数也随着梯度下降在不停更新。</p>
<ul>
<li>
<p>一方面，当底层网络中参数发生微弱变化时，由于每一层中的线性变换与非线性激活映射，这些微弱变化随着网络层数的加深而被放大（类似蝴蝶效应）；</p>
</li>
<li>
<p>另一方面，参数的变化导致每一层的输入分布会发生改变，进而上层的网络需要不停地去适应这些分布变化，使得我们的模型训练变得困难。这一现象叫做Internal Covariate Shift。</p>
</li>
</ul>
<h4 id="internal-covariate-shift"><a class="markdownIt-Anchor" href="#internal-covariate-shift"></a> Internal Covariate Shift</h4>
<p>一个较规范的定义：在深层网络训练的过程中，由于网络中参数变化而引起内部结点数据分布发生变化的这一过程被称作Internal Covariate Shift。</p>
<p>我们定义每一层的线性变换为 <img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D%3DW%5E%7B%5Bl%5D%7D%5Ctimes+input%2Bb%5E%7B%5Bl%5D%7D" alt="[公式]" />，其中 <img src="https://www.zhihu.com/equation?tex=l+" alt="[公式]" /> 代表层数；非线性变换为 <img src="https://www.zhihu.com/equation?tex=A%5E%7B%5Bl%5D%7D%3Dg%5E%7B%5Bl%5D%7D%28Z%5E%7B%5Bl%5D%7D%29" alt="[公式]" /> ，其中 <img src="https://www.zhihu.com/equation?tex=g%5E%7B%5Bl%5D%7D%28%5Ccdot%29" alt="[公式]" /> 为第 <img src="https://www.zhihu.com/equation?tex=l" alt="[公式]" />层的激活函数。</p>
<p>随着梯度下降的进行，每一层的参数 <img src="https://www.zhihu.com/equation?tex=W%5E%7B%5Bl%5D%7D" alt="[公式]" /> 与 <img src="https://www.zhihu.com/equation?tex=b%5E%7B%5Bl%5D%7D" alt="[公式]" /> 都会被更新，那么 <img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D" alt="[公式]" /> 的分布也就发生了改变，进而 <img src="https://www.zhihu.com/equation?tex=A%5E%7B%5Bl%5D%7D" alt="[公式]" /> 也同样出现分布的改变。而 <img src="https://www.zhihu.com/equation?tex=A%5E%7B%5Bl%5D%7D" alt="[公式]" /> 作为第 <img src="https://www.zhihu.com/equation?tex=l%2B1" alt="[公式]" /> 层的输入，意味着 <img src="https://www.zhihu.com/equation?tex=l%2B1" alt="[公式]" /> 层就需要去不停适应这种数据分布的变化。</p>
<h4 id="internal-covariate-shift带来的问题"><a class="markdownIt-Anchor" href="#internal-covariate-shift带来的问题"></a> Internal Covariate Shift带来的问题</h4>
<p><strong>（1）上层网络需要不停调整来适应输入数据分布的变化，导致网络学习速度的降低</strong></p>
<p>我们在上面提到了梯度下降的过程会让每一层的参数 <img src="https://www.zhihu.com/equation?tex=W%5E%7B%5Bl%5D%7D" alt="[公式]" /> 和 <img src="https://www.zhihu.com/equation?tex=b%5E%7B%5Bl%5D%7D" alt="[公式]" /> 发生变化，进而使得每一层的线性与非线性计算结果分布产生变化。后层网络就要不停地去适应这种分布变化，这个时候就会使得整个网络的学习速率过慢。</p>
<p><strong>（2）网络的训练过程容易陷入梯度饱和区，减缓网络收敛速度</strong></p>
<p>当我们在神经网络中采用饱和激活函数（saturated activation function）时，例如sigmoid，tanh激活函数，很容易使得模型训练陷入梯度饱和区（saturated regime）。</p>
<p>随着模型训练的进行，我们的参数 <img src="https://www.zhihu.com/equation?tex=W%5E%7B%5Bl%5D%7D" alt="[公式]" /> 会逐渐更新并变大，此时 <img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D%3DW%5E%7B%5Bl%5D%7DA%5E%7B%5Bl-1%5D%7D%2Bb%5E%7B%5Bl%5D%7D" alt="[公式]" /> 就会随之变大，并且 <img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D" alt="[公式]" /> 还受到更底层网络参数 <img src="https://www.zhihu.com/equation?tex=W%5E%7B%5B1%5D%7D%2CW%5E%7B%5B2%5D%7D%2C%5Ccdots%2CW%5E%7B%5Bl-1%5D%7D" alt="[公式]" /> 的影响，随着网络层数的加深， <img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D" alt="[公式]" /> 很容易陷入梯度饱和区，此时梯度会变得很小甚至接近于0，参数的更新速度就会减慢，进而就会放慢网络的收敛速度。</p>
<p>对于激活函数梯度饱和问题，有两种解决思路：</p>
<p>第一种就是更为非饱和性激活函数，例如线性整流函数ReLU可以在一定程度上解决训练进入梯度饱和区的问题。另一种思路是，我们可以让激活函数的输入分布保持在一个稳定状态来尽可能避免它们陷入梯度饱和区，这也就是Normalization的思路。</p>
<h3 id="batch-normalization"><a class="markdownIt-Anchor" href="#batch-normalization"></a> Batch Normalization</h3>
<h4 id="思路"><a class="markdownIt-Anchor" href="#思路"></a> 思路</h4>
<p>尝试单独对每个特征进行normalizaiton就可以了，让每个特征都有均值为0，方差为1的分布即可。在mini-batch的基础上进行计算。</p>
<h4 id="算法步骤"><a class="markdownIt-Anchor" href="#算法步骤"></a> 算法步骤</h4>
<p>介绍算法思路沿袭前面BN提出的思路来讲。第一点，对每个特征进行独立的normalization。我们考虑一个batch的训练，传入m个训练样本，并关注网络中的某一层，忽略上标 <img src="https://www.zhihu.com/equation?tex=l" alt="[公式]" /> 。</p>
<p><img src="https://www.zhihu.com/equation?tex=Z%5Cin+%5Cmathbb%7BR%7D%5E%7Bd_l%5Ctimes+m%7D" alt="[公式]" /></p>
<p>我们关注当前层的第 <img src="https://www.zhihu.com/equation?tex=j" alt="[公式]" /> 个维度，也就是第 <img src="https://www.zhihu.com/equation?tex=j" alt="[公式]" /> 个神经元结点，则有 <img src="https://www.zhihu.com/equation?tex=Z_j%5Cin+%5Cmathbb%7BR%7D%5E%7B1%5Ctimes+m%7D" alt="[公式]" /> 。我们当前维度进行规范化：</p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cmu_j%3D%5Cfrac%7B1%7D%7Bm%7D%5Csum_%7Bi%3D1%7D%5Em+Z_j%5E%7B%28i%29%7D" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_j%3D%5Cfrac%7B1%7D%7Bm%7D%5Csum_%7Bi%3D1%7D%5Em%28Z_j%5E%7B%28i%29%7D-%5Cmu_j%29%5E2" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Chat%7BZ%7D_j%3D%5Cfrac%7BZ_j-%5Cmu_j%7D%7B%5Csqrt%7B%5Csigma_j%5E2%2B%5Cepsilon%7D%7D" alt="[公式]" /></p>
<blockquote>
<p>其中 <img src="https://www.zhihu.com/equation?tex=%5Cepsilon" alt="[公式]" /> 是为了防止方差为0产生无效计算。</p>
</blockquote>
<p><img src="https://pic1.zhimg.com/80/v2-084e9875d10896369e09af5a60e56250_1440w.jpg" alt="img" /></p>
<p><img src="https://pic3.zhimg.com/80/v2-c37bda8f138402cc7c3dd62c509d36f6_1440w.jpg" alt="img" /></p>
<p>通过上面的变换，<strong>我们解决了第一个问题，即用更加简化的方式来对数据进行规范化，使得第 <img src="https://www.zhihu.com/equation?tex=l" alt="[公式]" />层的输入每个特征的分布均值为0，方差为1。</strong></p>
<p>如同上面提到的，Normalization操作我们虽然缓解了ICS问题，让每一层网络的输入数据分布都变得稳定，但却导致了数据表达能力的缺失。也就是我们通过变换操作改变了原有数据的信息表达（representation ability of the network），使得底层网络学习到的参数信息丢失。</p>
<p>另一方面，通过让每一层的输入分布均值为0，方差为1，会使得输入在经过sigmoid或tanh激活函数时，容易陷入非线性激活函数的线性区域。</p>
<p>因此，BN又引入了两个可学习（learnable）的参数 <img src="https://www.zhihu.com/equation?tex=%5Cgamma" alt="[公式]" /> 与 <img src="https://www.zhihu.com/equation?tex=%5Cbeta" alt="[公式]" /> 。</p>
<p>这两个参数的引入是<strong>为了恢复数据本身的表达能力</strong>，对规范化后的数据进行线性变换，即 <img src="https://www.zhihu.com/equation?tex=%5Ctilde%7BZ_j%7D%3D%5Cgamma_j+%5Chat%7BZ%7D_j%2B%5Cbeta_j" alt="[公式]" /> 。特别地，当 <img src="https://www.zhihu.com/equation?tex=%5Cgamma%5E2%3D%5Csigma%5E2%2C%5Cbeta%3D%5Cmu" alt="[公式]" /> 时，可以实现等价变换（identity transform)并且保留了原始输入特征的分布信息。<strong>通过上面的步骤，我们就在一定程度上保证了输入数据的表达能力。</strong></p>
<p>训练时，均值、方差分别是<strong>该批次</strong>内数据相应维度上的均值与方差；训练一旦结束，学习参数gamma和bata也就确定了。</p>
<p>以上就是整个Batch Normalization在模型训练中的算法和思路。</p>
<h4 id="计算公式"><a class="markdownIt-Anchor" href="#计算公式"></a> 计算公式</h4>
<p>对于神经网络中的第 <img src="https://www.zhihu.com/equation?tex=l" alt="[公式]" /> 层，我们有：</p>
<p><img src="https://www.zhihu.com/equation?tex=Z%5E%7B%5Bl%5D%7D%3DW%5E%7B%5Bl%5D%7DA%5E%7B%5Bl-1%5D%7D%2Bb%5E%7B%5Bl%5D%7D" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cmu%3D%5Cfrac%7B1%7D%7Bm%7D%5Csum_%7Bi%3D1%7D%5EmZ%5E%7B%5Bl%5D%28i%29%7D" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2%3D%5Cfrac%7B1%7D%7Bm%7D%5Csum_%7Bi%3D1%7D%5Em%28Z%5E%7B%5Bl%5D%28i%29%7D-%5Cmu%29%5E2" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Ctilde%7BZ%7D%5E%7B%5Bl%5D%7D%3D%5Cgamma%5Ccdot%5Cfrac%7BZ%5E%7B%5Bl%5D%7D-%5Cmu%7D%7B%5Csqrt%7B%5Csigma%5E2%2B%5Cepsilon%7D%7D%2B%5Cbeta" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=A%5E%7B%5Bl%5D%7D%3Dg%5E%7B%5Bl%5D%7D%28%5Ctilde%7BZ%7D%5E%7B%5Bl%5D%7D%29" alt="[公式]" /></p>
<h3 id="测试阶段使用batchnormalization"><a class="markdownIt-Anchor" href="#测试阶段使用batchnormalization"></a> 测试阶段使用BatchNormalization</h3>
<p>利用BN训练好模型后，我们保留了每组mini-batch训练数据在网络中每一层的 <img src="https://www.zhihu.com/equation?tex=%5Cmu_%7Bbatch%7D" alt="[公式]" /> 与 <img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_%7Bbatch%7D" alt="[公式]" />。此时我们使用整个样本的统计量来对Test数据进行归一化，具体来说使用均值与方差的无偏估计：</p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cmu_%7Btest%7D%3D%5Cmathbb%7BE%7D+%28%5Cmu_%7Bbatch%7D%29" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_%7Btest%7D%3D%5Cfrac%7Bm%7D%7Bm-1%7D%5Cmathbb%7BE%7D%28%5Csigma%5E2_%7Bbatch%7D%29" alt="[公式]" /></p>
<p>得到每个特征的均值与方差的无偏估计后，我们对test数据采用同样的normalization方法：</p>
<p><img src="https://www.zhihu.com/equation?tex=BN%28X_%7Btest%7D%29%3D%5Cgamma%5Ccdot+%5Cfrac%7BX_%7Btest%7D-%5Cmu_%7Btest%7D%7D%7B%5Csqrt%7B%5Csigma%5E2_%7Btest%7D%2B%5Cepsilon%7D%7D%2B%5Cbeta" alt="[公式]" /></p>
<h3 id="batch-normalization的优势"><a class="markdownIt-Anchor" href="#batch-normalization的优势"></a> Batch Normalization的优势</h3>
<p>Batch Normalization在实际工程中被证明了能够缓解神经网络难以训练的问题，BN具有的优势可以总结为以下三点：</p>
<p><strong>（1）BN使得网络中每层输入数据的分布相对稳定，加速模型学习速度</strong></p>
<p>BN通过规范化与线性变换使得每一层网络的输入数据的均值与方差都在一定范围内，使得后一层网络不必不断去适应底层网络中输入的变化，从而实现了网络中层与层之间的解耦，允许每一层进行独立学习，有利于提高整个神经网络的学习速度。</p>
<p><strong>（2）BN使得模型对网络中的参数不那么敏感，简化调参过程，使得网络学习更加稳定</strong></p>
<p>在神经网络中，我们经常会谨慎地采用一些权重初始化方法（例如Xavier）或者合适的学习率来保证网络稳定训练。</p>
<p>当学习率设置太高时，会使得参数更新步伐过大，容易出现震荡和不收敛。但是使用BN的网络将不会受到参数数值大小的影响。例如，我们对参数 <img src="https://www.zhihu.com/equation?tex=W" alt="[公式]" /> 进行缩放得到 <img src="https://www.zhihu.com/equation?tex=aW" alt="[公式]" /> 。对于缩放前的值 <img src="https://www.zhihu.com/equation?tex=Wu" alt="[公式]" /> ，我们设其均值为 <img src="https://www.zhihu.com/equation?tex=%5Cmu_1" alt="[公式]" /> ，方差为 <img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_1" alt="[公式]" /> ；对于缩放值 <img src="https://www.zhihu.com/equation?tex=aWu" alt="[公式]" /> ，设其均值为 <img src="https://www.zhihu.com/equation?tex=%5Cmu_2" alt="[公式]" /> ，方差为 <img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_2" alt="[公式]" /> ，则我们有：</p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cmu_2%3Da%5Cmu_1" alt="[公式]" /> ， <img src="https://www.zhihu.com/equation?tex=%5Csigma%5E2_2%3Da%5E2%5Csigma%5E2_1" alt="[公式]" /></p>
<p>我们忽略 <img src="https://www.zhihu.com/equation?tex=%5Cepsilon" alt="[公式]" /> ，则有：</p>
<p><img src="https://www.zhihu.com/equation?tex=BN%28aWu%29%3D%5Cgamma%5Ccdot%5Cfrac%7BaWu-%5Cmu_2%7D%7B%5Csqrt%7B%5Csigma%5E2_2%7D%7D%2B%5Cbeta%3D%5Cgamma%5Ccdot%5Cfrac%7BaWu-a%5Cmu_1%7D%7B%5Csqrt%7Ba%5E2%5Csigma%5E2_1%7D%7D%2B%5Cbeta%3D%5Cgamma%5Ccdot%5Cfrac%7BWu-%5Cmu_1%7D%7B%5Csqrt%7B%5Csigma%5E2_1%7D%7D%2B%5Cbeta%3DBN%28Wu%29" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial%7BBN%28%28aW%29u%29%7D%7D%7B%5Cpartial%7Bu%7D%7D%3D%5Cgamma%5Ccdot%5Cfrac%7BaW%7D%7B%5Csqrt%7B%5Csigma%5E2_2%7D%7D%3D%5Cgamma%5Ccdot%5Cfrac%7BaW%7D%7B%5Csqrt%7Ba%5E2%5Csigma%5E2_1%7D%7D%3D%5Cfrac%7B%5Cpartial%7BBN%28Wu%29%7D%7D%7B%5Cpartial%7Bu%7D%7D" alt="[公式]" /></p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial%7BBN%28%28aW%29u%29%7D%7D%7B%5Cpartial%7B%28aW%29%7D%7D%3D%5Cgamma%5Ccdot%5Cfrac%7Bu%7D%7B%5Csqrt%7B%5Csigma%5E2_2%7D%7D%3D%5Cgamma%5Ccdot%5Cfrac%7Bu%7D%7Ba%5Csqrt%7B%5Csigma%5E2_1%7D%7D%3D%5Cfrac%7B1%7D%7Ba%7D%5Ccdot%5Cfrac%7B%5Cpartial%7BBN%28Wu%29%7D%7D%7B%5Cpartial%7BW%7D%7D" alt="[公式]" /></p>
<blockquote>
<p>注：公式中的 <img src="https://www.zhihu.com/equation?tex=u" alt="[公式]" /> 是当前层的输入，也是前一层的输出</p>
</blockquote>
<p>我们可以看到，经过BN操作以后，权重的缩放值会被“抹去”，因此保证了输入数据分布稳定在一定范围内。另外，权重的缩放并不会影响到对 <img src="https://www.zhihu.com/equation?tex=u" alt="[公式]" /> 的梯度计算；</p>
<p>当权重越大时，即 <img src="https://www.zhihu.com/equation?tex=a" alt="[公式]" /> 越大， <img src="https://www.zhihu.com/equation?tex=%5Cfrac%7B1%7D%7Ba%7D" alt="[公式]" /> 越小，意味着权重 <img src="https://www.zhihu.com/equation?tex=W" alt="[公式]" /> 的梯度反而越小，这样BN就保证了梯度不会依赖于参数的scale，使得参数的更新处在更加稳定的状态。</p>
<p>因此，在使用Batch Normalization之后，抑制了参数微小变化随着网络层数加深被放大的问题，使得网络对参数大小的适应能力更强，此时我们可以设置较大的学习率而不用过于担心模型divergence的风险。</p>
<p><strong>（3）BN允许网络使用饱和性激活函数（例如sigmoid，tanh等），缓解梯度消失问题</strong></p>
<p>在不使用BN层的时候，由于网络的深度与复杂性，很容易使得底层网络变化累积到上层网络中，导致模型的训练很容易进入到激活函数的梯度饱和区；通过normalize操作可以让激活函数的输入数据落在梯度非饱和区，缓解梯度消失的问题；另外通过自适应学习 <img src="https://www.zhihu.com/equation?tex=%5Cgamma" alt="[公式]" /> 与 <img src="https://www.zhihu.com/equation?tex=%5Cbeta" alt="[公式]" /> 又让数据保留更多的原始信息。</p>
<p><strong>（4）BN具有一定的正则化效果</strong></p>
<p>在Batch Normalization中，由于我们使用mini-batch的均值与方差作为对整体训练样本均值与方差的估计，尽管每一个batch中的数据都是从总体样本中抽样得到，但不同mini-batch的均值与方差会有所不同，这就为网络的学习过程中增加了随机噪音，与Dropout通过关闭神经元给网络训练带来噪音类似，在一定程度上对模型起到了正则化的效果。</p>
<p>另外，原作者通过也证明了网络加入BN后，可以丢弃Dropout，模型也同样具有很好的泛化效果。</p>
<h3 id="适用场景"><a class="markdownIt-Anchor" href="#适用场景"></a> 适用场景</h3>
<p><strong>在神经网络训练时遇到收敛速度很慢，或梯度爆炸等无法训练的状况时可以尝试BN来解决</strong>。</p>
<p>另外，在一般使用情况下也可以加入BN来加快训练速度，提高模型精度。</p>
<p>BN 在每个 mini-batch 比较大，数据分布比较接近的场景比较适用。</p>
<p>在进行训练之前，要做好充分的shuffle，否则效果会差很多。</p>
<p>另外，由于BN需要在运行过程中统计每个mini-batch的一阶统计量和二阶统计量，因此不适用于动态的网络结构和RNN网络。</p>
<h3 id="python实现"><a class="markdownIt-Anchor" href="#python实现"></a> python实现</h3>
<h4 id="参数初始化"><a class="markdownIt-Anchor" href="#参数初始化"></a> 参数初始化</h4>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span></span></span></span> 初始化值为0，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span></span></span></span>初始化值为1</p>
<h4 id="更新策略"><a class="markdownIt-Anchor" href="#更新策略"></a> 更新策略</h4>
<p>参数更新策略：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>μ</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>m</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>u</mi><mi>m</mi><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>μ</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi></mrow></msub><mo>+</mo><mi>m</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>u</mi><mi>m</mi><mo>∗</mo><msub><mi>μ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow></msub><mspace linebreak="newline"></mspace><msubsup><mi>σ</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi><mo>+</mo><mn>1</mn></mrow><mn>2</mn></msubsup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>m</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>u</mi><mi>m</mi><mo stretchy="false">)</mo><mo>∗</mo><msubsup><mi>σ</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi></mrow><mn>2</mn></msubsup><mo>+</mo><mi>m</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>u</mi><mi>m</mi><mo>∗</mo><msubsup><mi>σ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mu _{statistic+1}=(1-momentum)*\mu _{statistic}+momentum*\mu _{now} \\
\sigma _{statistic+1}^{2}=(1-momentum)*\sigma _{statistic}^{2}+momentum*\sigma _{now}^{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.1694390000000001em;vertical-align:-0.305331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>在pytorch中对当前批次feature进行bn处理时所使用的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma _{now}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>是<strong>总体标准差</strong>，计算公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>μ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma _{now}^{2}=\frac{1}{m}\sum_{i=1}^{m}(x_{i}-\mu _{now})^{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>在更新统计量<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>c</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma _{statistic}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.072772em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>时采用的是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma _{now}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>是<strong>样本标准差</strong>，计算公式如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><mi>m</mi><mo>−</mo><mn>1</mn></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>μ</mi><mrow><mi>n</mi><mi>o</mi><mi>w</mi></mrow></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma _{now}^{2}=\frac{1}{m-1}\sum_{i=1}^{m}(x_{i}-\mu _{now})^{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<h4 id="两种实现方式"><a class="markdownIt-Anchor" href="#两种实现方式"></a> 两种实现方式</h4>
<p>验证是否和使用官方bn处理方法结果一致。</p>
<p><strong>第一种</strong>：</p>
<p>在bn_process中计算输入batch数据的每个维度（这里的维度是channel维度）的均值和标准差（标准差等于方差开平方）。</p>
<p>然后通过计算得到的均值和<strong>总体标准差</strong>对feature每个维度进行标准化，然后使用均值和<strong>样本标准差</strong>更新统计均值和标准差。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">bn_process</span>(<span class="params">x, mean, var</span>):</span><br><span class="line">    b, c, w, h = x.shape</span><br><span class="line">    <span class="comment"># 对每个通道进行BN</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(c):</span><br><span class="line">        x_c = x[:, i]</span><br><span class="line">        mean_c = x_c.mean()</span><br><span class="line">        std_1 = x_c.std()  <span class="comment"># 总体方差</span></span><br><span class="line">        std_2 = x_c.std(ddof=<span class="number">1</span>)  <span class="comment"># 样本方差（无偏估计</span></span><br><span class="line"></span><br><span class="line">        x[:, i] = (x[:, i] - mean_c) / np.sqrt(std_1 ** <span class="number">2</span> + <span class="number">1e-5</span>)</span><br><span class="line"></span><br><span class="line">        mean[i] = mean[i] * <span class="number">0.9</span> + mean_c * <span class="number">0.1</span></span><br><span class="line">        var[i] = var[i] * <span class="number">0.9</span> + (std_2 ** <span class="number">2</span>) * <span class="number">0.1</span>  <span class="comment"># 使用样本方差进行更行</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    </span><br><span class="line">x = torch.randn(<span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>)  <span class="comment"># 元素个数等于channel深度</span></span><br><span class="line">calculate_mean = [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>]</span><br><span class="line">calculate_var = [<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>]   </span><br><span class="line">bn_process(x.numpy().copy(), calculate_mean, calculate_var)</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[[[[ 0.77257067 -1.2975506 ]</span><br><span class="line">   [-0.3630766   1.4894383 ]]</span><br><span class="line"></span><br><span class="line">  [[-1.8136703  -0.01955615]</span><br><span class="line">   [-0.8204374   0.31605968]]</span><br><span class="line"></span><br><span class="line">  [[ 0.6743245   1.4604934 ]</span><br><span class="line">   [-0.369741   -1.151481  ]]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> [[[ 1.3495055  -1.004653  ]</span><br><span class="line">   [-0.2599011  -0.68633324]]</span><br><span class="line"></span><br><span class="line">  [[ 1.35173     1.0199517 ]</span><br><span class="line">   [-0.74816847  0.7140909 ]]</span><br><span class="line"></span><br><span class="line">  [[-0.2033853   0.32857594]</span><br><span class="line">   [ 0.95862955 -1.6974164 ]]]]</span><br></pre></td></tr></table></figure>
<p><strong>第二种</strong>：</p>
<p>设计为类，并用实例属性来保存一些变量值。</p>
<p>初始化中beta和gamma对应于BN中需要学习的参数，分别初始化为0和1，接下来就是前向传播的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BN</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, momentum, eps, num_features</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化参数值</span></span><br><span class="line"><span class="string">        :param momentum: 追踪样本整体均值和方差的动量</span></span><br><span class="line"><span class="string">        :param eps: 防止数值计算错误</span></span><br><span class="line"><span class="string">        :param num_features: 特征数量</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self._mean = <span class="number">0</span></span><br><span class="line">        self._std = <span class="number">1</span></span><br><span class="line">        self._momentum = momentum</span><br><span class="line">        self._eps = eps  <span class="comment"># 防止计算无效</span></span><br><span class="line">        self._num_features = num_features</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 对应learnable参数beta和gamma，采用pytorch文档中的初始化值</span></span><br><span class="line">        self._beta = np.zeros(shape=(num_features, ))</span><br><span class="line">        self._gamma = np.ones(shape=(num_features, ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_norm</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self._num_features):</span><br><span class="line">            x_c = x[:, i]</span><br><span class="line">            x_mean = x_c.mean()</span><br><span class="line">            </span><br><span class="line">            x_std_1 = x_c.std()</span><br><span class="line">            x_std_2 = x_c.std(ddof=<span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 对应mean的更新公式</span></span><br><span class="line">            self._mean = (<span class="number">1</span> - self._momentum) * x_mean + self._momentum * self._mean</span><br><span class="line">            self._std = (<span class="number">1</span> - self._momentum) * x_std_2 ** <span class="number">2</span> + self._momentum * self._std</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 对应论文中计算BN的公式</span></span><br><span class="line">            x_hat = (x_c - x_mean) / np.sqrt(x_std_1 ** <span class="number">2</span> + self._eps)</span><br><span class="line">            x[:, i] = x_hat</span><br><span class="line">            y = self._gamma[i] * x_hat + self._beta[i]  <span class="comment"># 恢复数据表达</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure>
<p>由于pytorch中的BatchNorm中beta和gamma初始化并不是0和1，为了保证初始化值一样，将自己定义的类的beta和gamm替换为torch初始化的值，进行如下测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bn2 = BN(momentum=<span class="number">0.1</span>, eps=<span class="number">1e-5</span>, num_features=<span class="number">3</span>)</span><br><span class="line">bn2._beta = bn.bias.detach().numpy()</span><br><span class="line">bn2._gamma = bn.weight.detach().numpy()</span><br><span class="line">bn2.batch_norm(x.numpy().copy())</span><br></pre></td></tr></table></figure>
<p>输出如下，可以发现两种实现方式的结果是相同的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[[[[ 0.77257067 -1.2975506 ]</span><br><span class="line">   [-0.3630766   1.4894383 ]]</span><br><span class="line"></span><br><span class="line">  [[-1.8136703  -0.01955615]</span><br><span class="line">   [-0.8204374   0.31605968]]</span><br><span class="line"></span><br><span class="line">  [[ 0.6743245   1.4604934 ]</span><br><span class="line">   [-0.369741   -1.151481  ]]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> [[[ 1.3495055  -1.004653  ]</span><br><span class="line">   [-0.2599011  -0.68633324]]</span><br><span class="line"></span><br><span class="line">  [[ 1.35173     1.0199517 ]</span><br><span class="line">   [-0.74816847  0.7140909 ]]</span><br><span class="line"></span><br><span class="line">  [[-0.2033853   0.32857594]</span><br><span class="line">   [ 0.95862955 -1.6974164 ]]]]</span><br></pre></td></tr></table></figure>
<p><strong>pytorch官方BN处理方法</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bn = nn.BatchNorm2d(<span class="number">3</span>, eps=<span class="number">1e-5</span>)  <span class="comment"># 3 = num_features</span></span><br><span class="line">output = bn(x)</span><br><span class="line"><span class="built_in">print</span>(output)  <span class="comment"># output 与 x的输出值相同</span></span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tensor([[[[ 0.7726, -1.2976],</span><br><span class="line">          [-0.3631,  1.4894]],</span><br><span class="line"></span><br><span class="line">         [[-1.8137, -0.0196],</span><br><span class="line">          [-0.8204,  0.3161]],</span><br><span class="line"></span><br><span class="line">         [[ 0.6743,  1.4605],</span><br><span class="line">          [-0.3697, -1.1515]]],</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [[[ 1.3495, -1.0047],</span><br><span class="line">          [-0.2599, -0.6863]],</span><br><span class="line"></span><br><span class="line">         [[ 1.3517,  1.0200],</span><br><span class="line">          [-0.7482,  0.7141]],</span><br><span class="line"></span><br><span class="line">         [[-0.2034,  0.3286],</span><br><span class="line">          [ 0.9586, -1.6974]]]], grad_fn=&lt;NativeBatchNormBackward&gt;)</span><br></pre></td></tr></table></figure>
<h3 id="参考博客"><a class="markdownIt-Anchor" href="#参考博客"></a> 参考博客</h3>
<ul>
<li>Batch Normalization原理与实战：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/34879333">https://zhuanlan.zhihu.com/p/34879333</a></li>
<li>Batch Normalization原理与python实现：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/100672008">https://zhuanlan.zhihu.com/p/100672008</a></li>
<li>Batch Normalization详解以及pytorch实验：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37541097/article/details/104434557">https://blog.csdn.net/qq_37541097/article/details/104434557</a></li>
<li>BN问题汇总：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wjinjie/article/details/118949226">https://blog.csdn.net/wjinjie/article/details/118949226</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/12/01/BatchNormalization%E5%8E%9F%E7%90%86%E4%B8%8Epython%E5%AE%9E%E7%8E%B0/" data-id="clkqxrno800081fj4azm08evc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-最近反思" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/30/%E6%9C%80%E8%BF%91%E5%8F%8D%E6%80%9D/" class="article-date">
  <time datetime="2021-11-30T15:29:17.000Z" itemprop="datePublished">2021-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/">生活记录</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/30/%E6%9C%80%E8%BF%91%E5%8F%8D%E6%80%9D/">最近反思</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Leetcode：</p>
<p>最近觉得自己的方法不对，只是追求做题的数量，没有保证速度和质量，像之前刷1000题的时候一样，对题目的理解不够深入，停留在很浅层的层面上。</p>
<p>可能还是需要多反思多总结，单纯计算量是无意义的。</p>
<p>主要是今天发现之前做过的一道题，虽说方法很巧妙，但居然完全忘记了，只是对题目有一点印象而已，结果还是重新写了一遍，跟最优解的思路完全不一样。</p>
<p>大无语事件，被打击到了，突然就觉得自己之前刷题像是没走心似的走了过场，特别是对于那些似懂非懂的算法题。</p>
<p>算法：</p>
<p>去年一直在质疑自己继续读计算机是不是正确的选择，为自己找借口，嫁祸给所谓的兴趣。后来受到启发，了解了心理学的就业和所学内容，b站有很多来自北师大的心理学生的劝退视频，都说毕业了就去社区服务或者是当心理咨询师，哎也不行，太穷了。虽然并不在乎钱，但是有钱确实可以任性一点。</p>
<p>找实习是为了体验一下工作后的氛围以及自己的变化，不想继续呆在学校的温室内。</p>
<p>光看理论的话，算法知识很容易遗忘，任何知识点都一样，还是得用起来，探索一些有趣的例子，或者是实现一下跑跑看，记得牢理解深。</p>
<p>小车不管倒退只管推，一条路走到黑，干就完事了。</p>
<p>情感：</p>
<p>我觉得自己在沟通交流上进步了很多，起码愿意主动提出一些问题，避免之后出现矛盾的可能。我希望之后能耐住性子对待别人，不越界不过分关心。允许正常的疏远亲密，希望每段关系都能有始有终。</p>
<p>给自己一些时间，继续沉淀奋力向前。<br />
从善如流~~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/11/30/%E6%9C%80%E8%BF%91%E5%8F%8D%E6%80%9D/" data-id="clkqxrnqk009m1fj4hu01b0db" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-图像分割中的Mask、One-hot、Label代码详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/29/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E4%B8%AD%E7%9A%84Mask%E3%80%81One-hot%E3%80%81Label%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2021-11-29T14:21:49.000Z" itemprop="datePublished">2021-11-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/29/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E4%B8%AD%E7%9A%84Mask%E3%80%81One-hot%E3%80%81Label%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/">图像分割中的Mask、One-hot、Label代码详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>图像分割是计算机视觉中除了分类和检测外的另一项基本任务，它意味着要将图片根据内容分割成不同的块。相比图像分类和检测，分割是一项更精细的工作，因为需要对每个像素点分类。</p>
<p>如下图的街景分割，由于对每个像素点都分类，物体的轮廓是精准勾勒的，而不是像检测那样给出边界框。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwvyymufhuj31lw0ewjub.jpg" alt="" /></p>
<p>图像分割可以分为以下三个子领域：语义分割（Semantic Segmentation）、实例分割（Instance Segmentation）、全景分割（Panoptic Segmentation）。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwvz1k7cetj318u0r4q9n.jpg" alt="" /></p>
<p>由对比图可发现，语义分割是从像素层次来识别图像，为图像中的每个像素制定类别标记；实例分割相对更具有挑战性，不仅需要正确检测图像中的目标，同时还要精确的分割每个实例；全景分割综合了两个任务，要求图像中的每个像素点都必须被分配给一个语义标签和一个实例id。</p>
<p>在进行网络训练时，时常需要对语义标签图或是实例分割图进行预处理。如对于一张彩色的标签图，通过颜色映射表得到每种颜色所代表的类别，再将其转换成相应的掩膜或Onehot编码完成训练。</p>
<p>这里以语义分割任务为例，介绍标签的不同表达形式。</p>
<h3 id="语义标签图"><a class="markdownIt-Anchor" href="#语义标签图"></a> 语义标签图</h3>
<p>语义分割数据集中包括原图和语义标签图，两者的尺寸大小相同，均为RGB图像。</p>
<p>在标签图像中，白色和黑色分别代表边框和背景，而其他不同颜色代表不同的类别：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gww0rzha3xj30yq0eajsy.jpg" alt="" /></p>
<h3 id="单通道掩膜"><a class="markdownIt-Anchor" href="#单通道掩膜"></a> 单通道掩膜</h3>
<p>每个标签的RGB值与各自的标注类别对应，则可以很容易地查找标签中每个像素的类别索引，生成单通道掩膜Mask。</p>
<p>如下面这种图，标注类别包括：Person、Purse、Plants、Sidewalk、Building。将语义标签图转换为单通道掩膜后为右图所示，尺寸大小不变，但通道数由3变为1。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gww0ua0e4tj31f80fkn16.jpg" alt="" /></p>
<p>每个像素点位置一一对应。</p>
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gww1l5ky6fj31200gg0ve.jpg" height="200px" />
<h3 id="onehot编码"><a class="markdownIt-Anchor" href="#onehot编码"></a> Onehot编码</h3>
<p>Onehot的作为一种编码方式，可以对每一个单通道掩膜进行编码。</p>
<p>比如对于上述掩膜图Mask，图像尺寸为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>H</mi><mo separator="true">,</mo><mi>W</mi><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[H,W,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，标签类别共有5类，我们需要将这个Mask变为一个5个通道的Onehot输出，尺寸为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mi>H</mi><mo separator="true">,</mo><mi>W</mi><mo separator="true">,</mo><mn>5</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[H,W,5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mclose">]</span></span></span></span>，也就是将掩膜中值全为1的像素点抽取出生成一个图，相应位置置为1，其余为0。再将全为2的抽取出再生成一个图，相应位置置为1，其余为0，以此类推。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gww1dt6cclj31cw0u00xa.jpg" alt="" /></p>
<p>接下来以Pascal VOC 2012语义分割数据集为例，介绍不同表达形式之间应该如何相互转换。</p>
<h3 id="pascal-voc2012"><a class="markdownIt-Anchor" href="#pascal-voc2012"></a> Pascal VOC2012</h3>
<p>Pascal VOC 2012语义分割数据集是语义分割任务中十分重要的数据集，有 20 类目标，这些目标包括人类、机动车类以及其他类，可用于目标类别或背景的分割。</p>
<h4 id="数据集读取"><a class="markdownIt-Anchor" href="#数据集读取"></a> 数据集读取</h4>
<p>本次使用格物钛提供的Tensorbay服务来完成数据集的在线读取，通过SDK支持更多数据集类型：</p>
<ul>
<li>ACCESS_KEY：获取使用SDK所需的密钥，<a target="_blank" rel="noopener" href="https://gas.graviti.cn/tensorbay/developer">点击获取</a></li>
<li>Segment：VOC数据集分成了“train”和“test”两个部分。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tensorbay <span class="keyword">import</span> GAS</span><br><span class="line"><span class="keyword">from</span> tensorbay.dataset <span class="keyword">import</span> Data, Dataset</span><br><span class="line"><span class="keyword">from</span> tensorbay.label <span class="keyword">import</span> InstanceMask, SemanticMask</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">ACCESS_KEY = <span class="string">&quot;&lt;YOUR_ACCESSKEY&gt;&quot;</span></span><br><span class="line">gas = GAS(ACCESS_KEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_voc_images</span>(<span class="params">is_train=<span class="literal">True</span>, index=<span class="number">0</span></span>):</span><br><span class="line">  	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    read voc image using tensorbay</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dataset = Dataset(<span class="string">&quot;VOC2012Segmentation&quot;</span>, gas) </span><br><span class="line">    <span class="keyword">if</span> is_train:</span><br><span class="line">        segment = dataset[<span class="string">&quot;train&quot;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        segment = dataset[<span class="string">&quot;test&quot;</span>]</span><br><span class="line"></span><br><span class="line">    data = segment[index]</span><br><span class="line">    feature = Image.<span class="built_in">open</span>(data.<span class="built_in">open</span>()).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">    label = Image.<span class="built_in">open</span>(data.label.semantic_mask.<span class="built_in">open</span>()).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">		visualize(feature, label)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> feature, label  <span class="comment"># PIL Image</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize</span>(<span class="params">feature, label</span>):</span><br><span class="line">  	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    visualize feature and label</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    fig = plt.figure()</span><br><span class="line">    ax = fig.add_subplot(<span class="number">121</span>)  <span class="comment"># 第一个子图</span></span><br><span class="line">    ax.imshow(feature)</span><br><span class="line">    ax2 = fig.add_subplot(<span class="number">122</span>)  <span class="comment"># 第二个子图</span></span><br><span class="line">    ax2.imshow(label)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line">train_feature, train_label = read_voc_images(is_train=<span class="literal">True</span>, index=<span class="number">10</span>)</span><br><span class="line">train_label = np.array(train_label) <span class="comment"># (375, 500, 3)</span></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gww20umx05j30yo0dsabu.jpg" alt="" /></p>
<h4 id="颜色映射表"><a class="markdownIt-Anchor" href="#颜色映射表"></a> 颜色映射表</h4>
<p>在得到彩色语义标签图后，则可以构建一个颜色表映射，列出标签中每个RGB颜色的值及其标注的类别。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">colormap_voc</span>():</span><br><span class="line">	  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    create a colormap</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    colormap = [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">128</span>, <span class="number">0</span>], [<span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>],</span><br><span class="line">                    [<span class="number">0</span>, <span class="number">0</span>, <span class="number">128</span>], [<span class="number">128</span>, <span class="number">0</span>, <span class="number">128</span>], [<span class="number">0</span>, <span class="number">128</span>, <span class="number">128</span>], [<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>],</span><br><span class="line">                    [<span class="number">64</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">192</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">64</span>, <span class="number">128</span>, <span class="number">0</span>], [<span class="number">192</span>, <span class="number">128</span>, <span class="number">0</span>],</span><br><span class="line">                    [<span class="number">64</span>, <span class="number">0</span>, <span class="number">128</span>], [<span class="number">192</span>, <span class="number">0</span>, <span class="number">128</span>], [<span class="number">64</span>, <span class="number">128</span>, <span class="number">128</span>], [<span class="number">192</span>, <span class="number">128</span>, <span class="number">128</span>],</span><br><span class="line">                    [<span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>], [<span class="number">128</span>, <span class="number">64</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">192</span>, <span class="number">0</span>], [<span class="number">128</span>, <span class="number">192</span>, <span class="number">0</span>],</span><br><span class="line">                    [<span class="number">0</span>, <span class="number">64</span>, <span class="number">128</span>]]</span><br><span class="line"></span><br><span class="line">    classes = [<span class="string">&#x27;background&#x27;</span>, <span class="string">&#x27;aeroplane&#x27;</span>, <span class="string">&#x27;bicycle&#x27;</span>, <span class="string">&#x27;bird&#x27;</span>, <span class="string">&#x27;boat&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;bottle&#x27;</span>, <span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;chair&#x27;</span>, <span class="string">&#x27;cow&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;diningtable&#x27;</span>, <span class="string">&#x27;dog&#x27;</span>, <span class="string">&#x27;horse&#x27;</span>, <span class="string">&#x27;motorbike&#x27;</span>, <span class="string">&#x27;person&#x27;</span>,</span><br><span class="line">                   <span class="string">&#x27;potted plant&#x27;</span>, <span class="string">&#x27;sheep&#x27;</span>, <span class="string">&#x27;sofa&#x27;</span>, <span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;tv/monitor&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> colormap, classes</span><br></pre></td></tr></table></figure>
<h4 id="label与onehot转换"><a class="markdownIt-Anchor" href="#label与onehot转换"></a> Label与Onehot转换</h4>
<p>根据映射表，实现语义标签图与Onehot编码的相互转换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">label_to_onehot</span>(<span class="params">label, colormap</span>):</span><br><span class="line">  	<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Converts a segmentation label (H, W, C) to (H, W, K) where the last dim is a one</span></span><br><span class="line"><span class="string">    hot encoding vector, C is usually 1 or 3, and K is the number of class.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    semantic_map = []</span><br><span class="line">    <span class="keyword">for</span> colour <span class="keyword">in</span> colormap:</span><br><span class="line">        equality = np.equal(label, colour)</span><br><span class="line">        class_map = np.<span class="built_in">all</span>(equality, axis=-<span class="number">1</span>)</span><br><span class="line">        semantic_map.append(class_map)</span><br><span class="line">    semantic_map = np.stack(semantic_map, axis=-<span class="number">1</span>).astype(np.float32)</span><br><span class="line">    <span class="keyword">return</span> semantic_map</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">onehot_to_label</span>(<span class="params">semantic_map, colormap</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Converts a mask (H, W, K) to (H, W, C)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    x = np.argmax(semantic_map, axis=-<span class="number">1</span>)</span><br><span class="line">    colour_codes = np.array(colormap)</span><br><span class="line">    label = np.uint8(colour_codes[x.astype(np.uint8)])</span><br><span class="line">    <span class="keyword">return</span> label</span><br><span class="line">  </span><br><span class="line">colormap, classes = colormap_voc()</span><br><span class="line">semantic_map = mask_to_onehot(train_label, colormap)</span><br><span class="line"><span class="built_in">print</span>(semantic_map.shape)  <span class="comment"># [H, W, K] = [375, 500, 21] 包括背景共21个类别</span></span><br><span class="line"></span><br><span class="line">label = onehot_to_label(semantic_map, colormap)</span><br><span class="line"><span class="built_in">print</span>(label.shape) <span class="comment"># [H, W, K] = [375, 500, 3]</span></span><br></pre></td></tr></table></figure>
<h4 id="onehot与mask转换"><a class="markdownIt-Anchor" href="#onehot与mask转换"></a> Onehot与Mask转换</h4>
<p>同样，借助映射表，实现单通道掩膜Mask与Onehot编码的相互转换：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">onehot2mask</span>(<span class="params">semantic_map</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Converts a mask (K, H, W) to (H,W)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    _mask = np.argmax(semantic_map, axis=<span class="number">0</span>).astype(np.uint8)</span><br><span class="line">    <span class="keyword">return</span> _mask</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mask2onehot</span>(<span class="params">mask, num_classes</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Converts a segmentation mask (H,W) to (K,H,W) where the last dim is a one</span></span><br><span class="line"><span class="string">    hot encoding vector</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    semantic_map = [mask == i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_classes)]</span><br><span class="line">    <span class="keyword">return</span> np.array(semantic_map).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">mask = onehot2mask(semantic_map.transpose(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(np.unique(mask)) <span class="comment"># [ 0  1 15] 索引相对应的是背景、飞机、人</span></span><br><span class="line"><span class="built_in">print</span>(mask.shape) <span class="comment"># (375, 500)</span></span><br><span class="line"></span><br><span class="line">semantic_map = mask2onehot(mask, <span class="built_in">len</span>(colormap))</span><br><span class="line"><span class="built_in">print</span>(semantic_map.shape) <span class="comment"># (21, 375, 500)</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/11/29/%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2%E4%B8%AD%E7%9A%84Mask%E3%80%81One-hot%E3%80%81Label%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3/" data-id="clkqxrnq400711fj4gqaoakug" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-卷积神经网络的发展历程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/11/19/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B/" class="article-date">
  <time datetime="2021-11-19T08:49:39.000Z" itemprop="datePublished">2021-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/11/19/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B/">卷积神经网络的发展历程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>按照发展顺序以及相互关系介绍：</p>
<h3 id="lenet"><a class="markdownIt-Anchor" href="#lenet"></a> LeNet</h3>
<p><strong>主要贡献</strong>：卷积神经网络的开山祖师爷，第一次定义了CNN的网络结构</p>
<p><strong>网络结构</strong>：2个卷积层 + 降采样（这时候都还不叫池化） + 激活函数 + 3个全连接层</p>
<ol>
<li>卷积层：局部连接、权值共享</li>
<li>降采样：窗口形状为2 * 2，步幅为2，选择局部区域内最大的值作为下采样的结果。池化区域不重叠。</li>
<li>激活函数：Tanh（现在都改成了ReLU</li>
</ol>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwj4jeuj4hj31nu0gk0vl.jpg" alt="" /></p>
<p>在LeNet后，针对数据与硬件这两个优化方向，提出了AlexNet。</p>
<h3 id="alexnet改进"><a class="markdownIt-Anchor" href="#alexnet改进"></a> AlexNet改进</h3>
<p><strong>网络结构</strong>：使用了5层卷积和2层全连接隐藏层，以及1个全连接输出层</p>
<p><strong>改进优势</strong>：</p>
<ol>
<li>以ReLU替代sigmoid或tanh，网络训练以更快速度收敛
<ul>
<li>当sigmoid激活函数输出极接近0或1时，这些区域的梯度几乎为0，从而造成反向传播无法继续更新部分模型参数</li>
<li>若模型参数初始化不当，sigmoid函数可能在正区间得到几乎为0的梯度，从而令模型无法得到有效训练</li>
<li>ReLU激活函数在正区间的梯度恒为1，负梯度为0，可以减少一半的计算量。</li>
</ul>
</li>
<li>双GPU并行计算：算力更强，因此可以使用更大更深的网络。（与参数有关）</li>
<li>重叠池化：Pooling窗口存在重叠。可以提高精度，不容易产生过拟合。可以减少一部分信息的丢失。</li>
<li>全连接层Dropout：
<ul>
<li>随机丢弃一定比例的神经元，被丢弃的神经元将不参加训练过程，权重也不做更新</li>
<li>每次迭代的时候，网络架构都不一样，可以大概率避免过拟合的发生（Ensemble Learning</li>
</ul>
</li>
<li>数据增强：翻转、裁剪和颜色变化，扩大数据集来缓解过拟合</li>
</ol>
<p>*注意：它的卷积窗口形状在不断减小，从11到3，这一变化与图像和特征图的尺寸是相关的。（防止捕捉不到物体就需要大一点的）</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwjbzm00z8j316o0eqdi7.jpg" alt="" /></p>
<h3 id="vgg"><a class="markdownIt-Anchor" href="#vgg"></a> VGG</h3>
<p><strong>网络结构</strong>：五个卷积层与激活函数的叠加部分 + 2个FC隐藏层 + 1个FC输出层</p>
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gwje67d6ltj31it0u00wo.jpg" height="250"/>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwje9pao82j323m0u0q76.jpg" alt="" /></p>
<p><strong>改进优势</strong>：</p>
<ol>
<li>
<p>用多个3*3小卷积核替换了大卷积核，并由此组成了不同的vgg块，在每个block的最后进行池化操作。</p>
<ul>
<li>
<p>5 * 5 感受野 --&gt; 3 * 3感受野 --&gt; 1</p>
</li>
<li>
<p>减少了网络参数量，减少计算量</p>
</li>
<li>
<p>更大的网络深度，非线性次数变多，使得学习能力变得更好</p>
</li>
</ul>
</li>
<li>
<p>使用了步幅为2，窗口形状为2 * 2的最大池化层，每次池化后的尺寸减半。上图的红色部分。</p>
</li>
<li>
<p>去掉了局部相应归一化层（BN）</p>
</li>
<li>
<p>允许使用多个尺度的图片进行训练：在最后一层使用的是全连接卷积神经网络，因此允许输入维度是变化的。(Multi-scale Training)</p>
</li>
</ol>
<p>*关于参数：前两层卷积占据了绝大部分的内存（因为图片尺寸较大）；第一层全连接层占据了绝大部分参数（4096 * 7 * 7 *512）</p>
<h3 id="googlenet"><a class="markdownIt-Anchor" href="#googlenet"></a> GoogLeNet</h3>
<p><strong>提出原因</strong>：（按推理顺序</p>
<ul>
<li>网络层数越深效果越好</li>
<li>模型越深参数越多，容易导致过拟合，且网络的计算量大</li>
<li>能否在增加复杂度的同时减少网络参数</li>
<li>设计出了GoogLeNet</li>
</ul>
<p><strong>主要思想</strong>：<strong>使用不同尺度的卷积核怼原图（输入）进行不同尺度的卷积，再将卷积结果做通道合并</strong>。4条线路子网络，并行抽取信息。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwki6s7uogj31700b83zh.jpg" alt="改进的Inception模块" /></p>
<p><strong>网络结构</strong>：9个Inception（原始结构无1*1卷积核）</p>
<ul>
<li>同样为5个模块，每个模块之间使用步幅为2的3*3最大池化减少输出的尺寸</li>
<li><strong>使用GAP替换了第一个全连接层，将每个通道的高宽变为1</strong></li>
<li>模块介绍：
<ul>
<li>1: 64通道的7 * 7卷积 + 3 * 3最大池化</li>
<li>2: 2个卷积层 + 最大池化
<ul>
<li>64通道的1*1卷积</li>
<li>3*3卷积</li>
</ul>
</li>
<li>3: 串联2个完成的Inception</li>
<li>4: 串联5个（在第2个和第5个部分设置了额外的辅助 Loss，用以增加向后传导的梯度，缓解梯度消失问题</li>
<li>5: 串联2个</li>
</ul>
</li>
</ul>
<h3 id="resnet"><a class="markdownIt-Anchor" href="#resnet"></a> ResNet</h3>
<p><strong>结构对比</strong>：</p>
<ul>
<li>普通：输入为x，直接拟合理想映射fx</li>
<li>ResNet：理想映射仍为fx，但拟合对象为与恒等映射有关的残差映射fx-x；当虚线框内的权重与偏置均为0时，fx=x为恒等映射。</li>
</ul>
<p><strong>主要贡献</strong>：</p>
<ul>
<li>近道具有自我闭合的能力：结合网络结构看，若网络在层次加深时性能退化，则它可以通过控制网络中的近道和非近道的组合比例来退回之前浅层的状态。也就是说，虚线内参数全部为0时可以恢复到之前的状态，至少不会变差。</li>
<li>能缩短误差反向传播到各层的路径，有效抑制梯度消失的现象，从而使网络在不断加深时性能也不会下降。</li>
<li>成功解决了网络退化的问题。</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gwkis5hqh4j316k0ge0u0.jpg" height="250" />
<p><strong>主要思想</strong>：添加了跳跃连接</p>
<p><strong>网络结构</strong>：</p>
<ul>
<li>沿用了VGG全3*3卷积的设计，重新加上了BN</li>
<li>每个残差块里有2个3*3的卷积，第一个后面接了BN和ReLU，第二个后面只接了BN</li>
<li>模块结构
<ul>
<li>1: 64通道的7 * 7卷积 + BN + 3 * 3最大池化</li>
<li>2: 后接4个由残差块组成的模块，每个模块包含若干个残差块（原文为2个）。因此共有8个残差块，每个模块都进行了4次卷积。</li>
<li><strong>每个模块在第一残差块里将上一个模块的通道数翻倍，并将高宽减半；第二个保持尺寸。</strong></li>
<li>GAP后接全连接层，因此整个网络共 1 + 16 + 1 = 18层</li>
</ul>
</li>
</ul>
<img src="https://tva1.sinaimg.cn/large/008i3skNly1gwkj5lesboj30920fqweo.jpg" height="150" />
<h3 id="densenet"><a class="markdownIt-Anchor" href="#densenet"></a> DenseNet</h3>
<p><strong>网络结构</strong>：跳跃连接，使用通道连接</p>
<ul>
<li>稠密块：
<ul>
<li>每块的输入与输出在通道维上连结</li>
<li>由多个卷积块组成，卷积块顺序为 BN + ReLU + Conv</li>
<li>比如一个稠密块内包含了4个卷积，每个卷积输出为32。每个卷积的输入尺寸是变化的（是上层输入和输出的拼接），但输出尺寸不变。而最后稠密块的输出通道相比于输入，将增加128个通道，</li>
</ul>
</li>
<li>过渡层：
<ul>
<li>1*1卷积 + 平均池化，实现尺寸、通道减半</li>
<li>功能：由于稠密块会增加通道数，因此在两个稠密块之间加入过渡层，可以控制模型复杂度</li>
</ul>
</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gwkjdu36fyj32a80d4q6e.jpg" alt="" /></p>
<p><strong>结构特点</strong>：</p>
<ul>
<li>特征复用：每个卷积块使用相同的输出通道数。将每块的输入与输出在通道维上连结，以做为下一块的输入特征复用</li>
<li>卷积块的通道数控制了输出通道数，相当于输入通道数的增长</li>
</ul>
<p><strong>优点</strong>：通过特征复用来减少网络的参数量，在一定程度上缓解了梯度消失。</p>
<h3 id="相关问题"><a class="markdownIt-Anchor" href="#相关问题"></a> 相关问题</h3>
<h4 id="q1-卷积-池化公式计算"><a class="markdownIt-Anchor" href="#q1-卷积-池化公式计算"></a> Q1. 卷积 &amp; 池化公式计算</h4>
<p>假设卷积核大小为K，移动步幅为stride，开始时特征图大小为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{in}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，填充为P，卷积后特征图大小为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">第一次卷积: 1 —— K</span><br><span class="line">第二次卷积: 1 + stride —— K + stride</span><br><span class="line">第三次卷积: 1 + 2*stride —— K + 2*stride</span><br><span class="line">...</span><br><span class="line">第t次卷积: 1 + (t-1)*stride —— K + (t-1)*stride</span><br><span class="line"></span><br><span class="line">假设经过t次卷积后结束后</span><br><span class="line">K + (t-1)*stride = S<span class="built_in">_</span>in + 2P</span><br></pre></td></tr></table></figure>
<p>上述公式经过移项后，可得</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mfrac><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>+</mo><mn>2</mn><mi>P</mi><mo>−</mo><mi>K</mi></mrow><mrow><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi></mrow></mfrac><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">S_{out} = \frac{S_{in}+2P-K}{stride} + 1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>由于池化时不需要填充，因此依照上述的分析，可以直接得到</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>S</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mfrac><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>−</mo><mi>K</mi></mrow><mrow><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi></mrow></mfrac><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">S_{out} = \frac{S_{in}-K}{stride} + 1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">i</span><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<h4 id="q2-池化层及其作用"><a class="markdownIt-Anchor" href="#q2-池化层及其作用"></a> Q2. 池化层及其作用</h4>
<p><strong>作用</strong>：</p>
<ol>
<li>减少参数量，有效防止过拟合现象</li>
<li>保持对平移（小量）、伸缩、旋转操作的不变性</li>
<li>提高感受野的大小</li>
</ol>
<p><strong>Average Pooling</strong>:</p>
<p>取窗口内的平均值作为结果，可以保留背景信息。</p>
<p>反向传播将把梯度等分为k * k份分配给前一层，保证池化前后的梯度（残差）之和保持不变。</p>
<p><strong>Maximum Pooling</strong>:</p>
<p>去窗口内的最大值作为结果传递，可以提取特征纹理，减少无用信息的影响。</p>
<p>反向传播也就是把梯度直接传给前一层某一个像素，而其他像素不接受梯度，也就是为0。</p>
<p><strong>Global Pooling</strong>:</p>
<p>不以窗口的形式取均值，而是以feature map为单位进行均值化，一个feature map输出一个值。</p>
<h4 id="q3-卷积的本质"><a class="markdownIt-Anchor" href="#q3-卷积的本质"></a> Q3. 卷积的本质</h4>
<ol>
<li>从积分公式理解：不稳定的输入fx，稳定的输出gx，求得系统存量</li>
<li>周围像素点对当前像素值如何产生影响</li>
<li>一个像素点如何向周围进行试探（Sobel算子等</li>
</ol>
<p>代入理解每一层的卷积过程：</p>
<ul>
<li>
<p>假如第一层的卷积提取的是图像的浅层语义信息，如入最简单的边缘。</p>
</li>
<li>
<p>随着层数的增多，某一像素点将表示感受野中众多像素点对其影响逐步积累，进而得到可以表达该图像的深层语义特征。</p>
</li>
</ul>
<h4 id="q4-1times1卷积核的作用"><a class="markdownIt-Anchor" href="#q4-1times1卷积核的作用"></a> Q4. 1$\times$1卷积核的作用</h4>
<p>1*1卷积核的通道数与输入特征图应该相同。</p>
<p>作用如下：</p>
<ul>
<li><strong>实现降维</strong>或升维，减少通道数从而降低模型复杂度</li>
<li>跨通道信息交融</li>
<li><strong>减少了参数量</strong></li>
<li>增加模型的深度，进而提高非线性的表示能力</li>
</ul>
<h4 id="q5-网络退化-过拟合-梯度消失之间的关系"><a class="markdownIt-Anchor" href="#q5-网络退化-过拟合-梯度消失之间的关系"></a> Q5. 网络退化、过拟合、梯度消失之间的关系</h4>
<p>网络退化：学习效果并非随着网络深度的增加而变好。56层的表现比22层差。</p>
<p>过拟合：训练集表现好，但测试集差。出现退化时，无论是训练集还是测试集，56层的效果都比22差。</p>
<p>梯度消失：效果随着训练迭代不会变好，梯度不再更新。但是退化时还是有很明显的梯度变化。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yluy.gitee.io/2021/11/19/%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B/" data-id="clkqxrnq4006y1fj46bpjacin" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E7%AD%89/" rel="tag">中等</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/JavaScript/">JavaScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/">图像处理</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/openCV/">openCV</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%85%AC%E5%BC%8F%E6%8E%A8%E5%AF%BC/">公式推导</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86/">算法原理</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">深度学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/">生活记录</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">疑难杂症</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E4%BA%8C%E5%8F%89%E6%A0%91/">二叉树</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E4%BD%8D%E8%BF%90%E7%AE%97/">位运算</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/">刷题记录</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%9B%BE%E8%AE%BA/">图论</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%B9%B6%E6%9F%A5%E9%9B%86/">并查集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F/">排序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E6%A0%88%E5%92%8C%E9%98%9F%E5%88%97/">栈和队列</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E8%B4%AA%E5%BF%83%E7%AE%97%E6%B3%95/">贪心算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E9%93%BE%E8%A1%A8/">链表</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/">阅读笔记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/%E8%AE%BA%E6%96%87/">论文</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%98%85%E8%AF%BB%E8%AE%B0%E5%BD%95/">阅读记录</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CVPR/" rel="tag">CVPR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Colorization/" rel="tag">Colorization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GAN/" rel="tag">GAN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/" rel="tag">Leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SIGGRAPH/" rel="tag">SIGGRAPH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/" rel="tag">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/todoList/" rel="tag">todoList</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E7%AD%89/" rel="tag">中等</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%B0%E9%9A%BE/" rel="tag">困难</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E7%BF%BB%E8%AF%91/" rel="tag">图像翻译</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E6%9C%AC%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90/" rel="tag">文本图像生成</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" rel="tag">神经网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%80%E5%8D%95/" rel="tag">简单</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B5%84%E6%96%99/" rel="tag">资料</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CVPR/" style="font-size: 12.5px;">CVPR</a> <a href="/tags/Colorization/" style="font-size: 15px;">Colorization</a> <a href="/tags/GAN/" style="font-size: 15px;">GAN</a> <a href="/tags/Leetcode/" style="font-size: 10px;">Leetcode</a> <a href="/tags/SIGGRAPH/" style="font-size: 10px;">SIGGRAPH</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/todoList/" style="font-size: 10px;">todoList</a> <a href="/tags/%E4%B8%AD%E7%AD%89/" style="font-size: 20px;">中等</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 15px;">其他</a> <a href="/tags/%E5%9B%B0%E9%9A%BE/" style="font-size: 10px;">困难</a> <a href="/tags/%E5%9B%BE%E5%83%8F%E7%BF%BB%E8%AF%91/" style="font-size: 10px;">图像翻译</a> <a href="/tags/%E6%96%87%E6%9C%AC%E5%9B%BE%E5%83%8F%E7%94%9F%E6%88%90/" style="font-size: 10px;">文本图像生成</a> <a href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" style="font-size: 12.5px;">神经网络</a> <a href="/tags/%E7%AE%80%E5%8D%95/" style="font-size: 17.5px;">简单</a> <a href="/tags/%E8%B5%84%E6%96%99/" style="font-size: 10px;">资料</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/07/31/Hexo-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E5%9B%BE%E5%BA%8A%E5%9B%BE%E7%89%87/">Hexo 无法加载图床图片</a>
          </li>
        
          <li>
            <a href="/2022/03/14/Javascript%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E9%97%AD%E5%8C%85/">Javascript作用域与闭包</a>
          </li>
        
          <li>
            <a href="/2022/03/14/Javascript%E5%8E%9F%E5%9E%8B%E4%B8%8E%E5%8E%9F%E5%9E%8B%E9%93%BE/">Javascript原型与原型链</a>
          </li>
        
          <li>
            <a href="/2022/03/14/Javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">Javascript异步编程</a>
          </li>
        
          <li>
            <a href="/2021/12/17/%E5%86%B3%E7%AD%96%E6%A0%91%E7%AC%94%E8%AE%B0/">决策树笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 Sonata<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>